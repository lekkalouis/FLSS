# FLSS Shopify Canonical Data Model Migration

## 1) Full audit report of unlinked/weakly linked operational data

```json
[
  { "entity": "order.parcel_count", "currentlyStoredWhere": "tag", "shouldBe": "metaobject", "ownerResource": "order" },
  { "entity": "order.estimated_parcels", "currentlyStoredWhere": "metafield", "shouldBe": "metaobject", "ownerResource": "order" },
  { "entity": "order.po_number", "currentlyStoredWhere": "note", "shouldBe": "metaobject", "ownerResource": "order" },
  { "entity": "order.shipping_quote_no", "currentlyStoredWhere": "note", "shouldBe": "metaobject", "ownerResource": "order" },
  { "entity": "order.price_tier_selection", "currentlyStoredWhere": "note", "shouldBe": "metaobject", "ownerResource": "order" },
  { "entity": "order.dispatch_lane", "currentlyStoredWhere": "tag", "shouldBe": "metaobject", "ownerResource": "order" },
  { "entity": "order.dispatch_progress(packed/booked/fulfilled)", "currentlyStoredWhere": "memory", "shouldBe": "metaobject", "ownerResource": "order" },
  { "entity": "order.packing_boxes_and_allocations", "currentlyStoredWhere": "memory", "shouldBe": "metaobject", "ownerResource": "order" },
  { "entity": "order.courier_booking/waybill", "currentlyStoredWhere": "memory", "shouldBe": "metaobject", "ownerResource": "order" },
  { "entity": "order.scan_station_state", "currentlyStoredWhere": "memory", "shouldBe": "metaobject", "ownerResource": "order" },
  { "entity": "customer.tier", "currentlyStoredWhere": "tag", "shouldBe": "metaobject", "ownerResource": "customer" },
  { "entity": "customer.delivery_method", "currentlyStoredWhere": "metafield", "shouldBe": "metaobject", "ownerResource": "customer" },
  { "entity": "customer.parcelperfect_place_code", "currentlyStoredWhere": "metafield", "shouldBe": "metaobject", "ownerResource": "customer" },
  { "entity": "variant.sku_physical(weight/volume/package)", "currentlyStoredWhere": "not stored", "shouldBe": "metaobject", "ownerResource": "variant" },
  { "entity": "variant.price_tiers", "currentlyStoredWhere": "metafield", "shouldBe": "metaobject", "ownerResource": "variant" },
  { "entity": "dispatch.ui.daily_parcel_counter", "currentlyStoredWhere": "memory", "shouldBe": "metaobject", "ownerResource": "shop" },
  { "entity": "dispatch.ui.truck_booking_summary", "currentlyStoredWhere": "memory", "shouldBe": "metaobject", "ownerResource": "shop" }
]
```

## 2) Canonical GraphQL definitions

```graphql
mutation EnsureMetaobjectDefinitions {
  # flss_sku_master
  metaobjectDefinitionCreate(definition: {
    type: "flss_sku_master"
    name: "FLSS SKU Master"
    access: { admin: MERCHANT_READ_WRITE }
    fieldDefinitions: [
      { key: "sku_code", name: "SKU Code", type: "single_line_text_field", required: true },
      { key: "variant_id", name: "Variant ID", type: "number_integer", required: true },
      { key: "weight_grams", name: "Weight (grams)", type: "number_decimal" },
      { key: "volume_cm3", name: "Volume (cm3)", type: "number_decimal" },
      { key: "packaging_type", name: "Packaging Type", type: "single_line_text_field" },
      { key: "default_box_type", name: "Default Box Type", type: "metaobject_reference" }
    ]
  }) { userErrors { field message } }

  # flss_packing_plan
  metaobjectDefinitionCreate(definition: {
    type: "flss_packing_plan"
    name: "FLSS Packing Plan"
    access: { admin: MERCHANT_READ_WRITE }
    fieldDefinitions: [
      { key: "order_id", name: "Order ID", type: "number_integer", required: true },
      { key: "parcels_json", name: "Parcels JSON", type: "json" },
      { key: "total_weight_kg", name: "Total Weight (kg)", type: "number_decimal" },
      { key: "total_volume_cm3", name: "Total Volume (cm3)", type: "number_decimal" },
      { key: "confidence_score", name: "Confidence Score", type: "number_decimal" },
      { key: "generated_by", name: "Generated By", type: "single_line_text_field" }
    ]
  }) { userErrors { field message } }

  # flss_courier_booking
  metaobjectDefinitionCreate(definition: {
    type: "flss_courier_booking"
    name: "FLSS Courier Booking"
    access: { admin: MERCHANT_READ_WRITE }
    fieldDefinitions: [
      { key: "order_id", name: "Order ID", type: "number_integer", required: true },
      { key: "courier_name", name: "Courier Name", type: "single_line_text_field" },
      { key: "waybill_number", name: "Waybill Number", type: "single_line_text_field" },
      { key: "service_level", name: "Service Level", type: "single_line_text_field" },
      { key: "labels", name: "Labels", type: "list.file_reference" },
      { key: "booking_status", name: "Booking Status", type: "single_line_text_field" }
    ]
  }) { userErrors { field message } }

  # flss_customer_profile
  metaobjectDefinitionCreate(definition: {
    type: "flss_customer_profile"
    name: "FLSS Customer Profile"
    access: { admin: MERCHANT_READ_WRITE }
    fieldDefinitions: [
      { key: "customer_id", name: "Customer ID", type: "number_integer", required: true },
      { key: "tier", name: "Tier", type: "single_line_text_field" },
      { key: "price_group", name: "Price Group", type: "single_line_text_field" },
      { key: "delivery_method", name: "Delivery Method", type: "single_line_text_field" },
      { key: "parcelperfect_place_code", name: "ParcelPerfect Place Code", type: "single_line_text_field" }
    ]
  }) { userErrors { field message } }

  # flss_dispatch_state
  metaobjectDefinitionCreate(definition: {
    type: "flss_dispatch_state"
    name: "FLSS Dispatch State"
    access: { admin: MERCHANT_READ_WRITE }
    fieldDefinitions: [
      { key: "order_id", name: "Order ID", type: "number_integer", required: true },
      { key: "lane", name: "Lane", type: "single_line_text_field" },
      { key: "packed", name: "Packed", type: "boolean" },
      { key: "booked", name: "Booked", type: "boolean" },
      { key: "fulfilled", name: "Fulfilled", type: "boolean" },
      { key: "scan_station_state", name: "Scan Station State", type: "json" }
    ]
  }) { userErrors { field message } }
}
```

```graphql
mutation EnsureFlssMetafields {
  orderPacking: metafieldDefinitionCreate(definition: {
    name: "FLSS Packing Plan Ref",
    namespace: "flss",
    key: "packing_plan_ref",
    ownerType: ORDER,
    type: "metaobject_reference"
  }) { userErrors { field message } }

  orderCourier: metafieldDefinitionCreate(definition: {
    name: "FLSS Courier Booking Ref",
    namespace: "flss",
    key: "courier_booking_ref",
    ownerType: ORDER,
    type: "metaobject_reference"
  }) { userErrors { field message } }

  orderDispatch: metafieldDefinitionCreate(definition: {
    name: "FLSS Dispatch State Ref",
    namespace: "flss",
    key: "dispatch_state_ref",
    ownerType: ORDER,
    type: "metaobject_reference"
  }) { userErrors { field message } }

  customerProfile: metafieldDefinitionCreate(definition: {
    name: "FLSS Profile Ref",
    namespace: "flss",
    key: "profile_ref",
    ownerType: CUSTOMER,
    type: "metaobject_reference"
  }) { userErrors { field message } }

  variantSku: metafieldDefinitionCreate(definition: {
    name: "FLSS SKU Master Ref",
    namespace: "flss",
    key: "sku_master_ref",
    ownerType: PRODUCTVARIANT,
    type: "metaobject_reference"
  }) { userErrors { field message } }
}
```

## 3) Migration notes

- Keep existing REST metafield reads/writes for `custom.parcel_count` and `custom.estimated_parcels` as fallback while UI endpoints migrate to `flss.*` reference metafields.
- Keep tags only for Flow trigger semantics (`dispatch_flow` etc.), not as authoritative operational data.
- Server startup now attempts definition bootstrap with fail-safe warnings (non-fatal).
- New service (`src/services/flssMeta.js`) centralizes GraphQL definition creation, metaobject upserts, and reference linking.
- Caches in `flssMeta` reduce repeat lookups/links for high-frequency dispatch updates.
