<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Flippen Lekka Scan Station — v5 (cleaned + 100×150 print lock)</title>
<style>
  :root{
    --bg:#f5f7fb;
    --panel:#ffffff;
    --panel-muted:#f1f5f9;
    --panel-strong:#e2e8f0;
    --text:#0f172a;
    --text-muted:#5b6b7f;
    --accent:#38bdf8;
    --accent-soft:rgba(56,189,248,.18);
    --radius-lg:.75rem;
    --radius-md:.5rem;
    --mono:ui-monospace,SFMono-Regular,Consolas,"Liberation Mono",Menlo,monospace;
    --sans:-apple-system,BlinkMacSystemFont,Inter,Roboto,"Segoe UI",system-ui,sans-serif;
    --print-scale:1.0; /* safe inner scaling for printers that overscan */
  }
  *{box-sizing:border-box}
  body{
    background:radial-gradient(circle at 10% 10%, rgba(56,189,248,.15) 0%, rgba(245,247,251,0) 55%),
               radial-gradient(circle at 90% 20%, rgba(236,72,153,.08) 0%, rgba(245,247,251,0) 55%),
               var(--bg);
    color:var(--text);
    font-family:var(--sans);
    min-height:100dvh;
    margin:0;
  }
  .flApp{
    min-height:100dvh;
    display:flex;
    flex-direction:column;
    gap:1.5rem;
    padding:1.75rem;
  }
  @media (max-width:800px){
    .flApp{ padding:1.25rem; gap:1.25rem; }
  }
  .flNav{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:1.25rem;
    padding:.85rem 1.25rem;
    border-radius:var(--radius-lg);
    background:rgba(255,255,255,.9);
    border:1px solid var(--panel-strong);
    box-shadow:0 18px 40px rgba(15,23,42,.08);
    backdrop-filter:blur(14px) saturate(140%);
  }
  .flNavTitle{
    font-weight:700;
    letter-spacing:.02em;
    color:var(--text);
    font-size:.95rem;
  }
  .flNavGroup{
    display:flex;
    align-items:center;
    gap:.65rem;
    flex-wrap:wrap;
  }
  .flNavBtn{
    border:1px solid var(--panel-strong);
    background:#fff;
    color:var(--text);
    font-weight:600;
    font-size:.85rem;
    padding:.5rem .9rem;
    border-radius:.7rem;
    cursor:pointer;
    transition:all .2s ease;
    text-decoration:none;
    display:inline-flex;
    align-items:center;
  }
  .flNavBtn:hover{
    border-color:rgba(56,189,248,.65);
    color:var(--text);
  }
  .flNavBtn--active{
    background:var(--accent-soft);
    border-color:rgba(56,189,248,.8);
    color:#0c4a6e;
    box-shadow:0 6px 18px rgba(56,189,248,.18);
  }
  .flNavStatus{
    display:flex;
    align-items:center;
    gap:.6rem;
    flex-wrap:wrap;
  }
  .actionFlash{
    font-size:.72rem;
    color:var(--text-muted);
    background:var(--panel-muted);
    border:1px solid var(--panel-strong);
    border-radius:var(--radius-md);
    padding:.3rem .55rem;
    opacity:.75;
    transition:opacity .2s ease;
  }
  .actionFlash--ok{ border-color:rgba(34,197,94,.55); color:#bbf7d0; }
  .actionFlash--warn{ border-color:rgba(251,191,36,.6); color:#fde68a; }
  .actionFlash--err{ border-color:rgba(248,113,113,.6); color:#fecaca; }
  .actionFlash--booked{
    color:#052e16;
    border-color:rgba(34,197,94,.85);
    background:linear-gradient(120deg, rgba(34,197,94,.9), rgba(74,222,128,.8));
    box-shadow:0 0 24px rgba(34,197,94,.55);
    animation:bookedFlash 1.2s ease-in-out 2;
  }
  @keyframes bookedFlash{
    0%{ transform:scale(1); opacity:.7; }
    35%{ transform:scale(1.06); opacity:1; }
    70%{ transform:scale(1); opacity:.85; }
    100%{ transform:scale(1); opacity:.7; }
  }
  .flView{
    width:100%;
  }
  .flView[hidden]{ display:none; }
  .flView .shell{ margin:0 auto; }
  .shell{
    width:100%;
    max-width:1180px;
    background:rgba(255,255,255,.95);
    box-shadow:0 30px 80px rgba(15,23,42,.12), 0 0 120px rgba(56,189,248,.08) inset;
    backdrop-filter:blur(18px) saturate(140%);
    display:grid;
    grid-template-columns:1fr 1fr;
    overflow:hidden;
  }
  @media (max-width:1000px){ .shell{ grid-template-columns:1fr; } }

  /* LEFT */
  .leftPane{
    background:linear-gradient(to bottom right, rgba(255,255,255,.95), rgba(241,245,249,.7));
    padding:1.25rem;
    border-right:1px solid var(--panel-strong);
  }
  @media (max-width:1000px){ .leftPane{ border-right:0; border-bottom:1px solid rgba(148,163,184,.15);} }
  .headerRow{ display:flex; align-items:flex-start; justify-content:space-between; gap:.75rem; flex-wrap:wrap; margin-bottom:.75rem; }
  .line1{ font-size:.95rem; font-weight:700; color:var(--text); display:flex; gap:.5rem 1rem; align-items:center; flex-wrap:wrap; }
  .badge{ background:var(--accent-soft); border:1px solid rgba(56,189,248,.5); color:#0c4a6e; font-size:1.1rem; border-radius:var(--radius-md); padding:.2rem .45rem; }
  .sessionInfo{ font-size:.8rem; color:var(--text-muted); line-height:1.4; font-family:var(--mono);} 
  .scanBox,.addrBox,.card{ background:var(--panel); border:1px solid var(--panel-strong); border-radius:var(--radius-md); padding:.75rem; }
  .scanBox{ margin-bottom:1rem; }
  .scanBox label{ display:flex; justify-content:space-between; align-items:baseline; font-size:.75rem; color:var(--text-muted); margin-bottom:.5rem; }
  .scanBox label small{ color:#7c8da1; font-weight:400; font-size:.7rem; }
  #scanInput{ width:100%; background:#fff; border:1px solid var(--panel-strong); border-radius:var(--radius-md); color:var(--text); font-family:var(--mono); font-size:1rem; outline:none; padding:.5rem .6rem; }
  #scanInput:focus{ border-color:var(--accent); box-shadow:0 0 20px rgba(56,189,248,.4); }
  .btn{
    border:1px solid rgba(56,189,248,.5);
    background:var(--accent-soft);
    color:#0c4a6e;
    font-weight:700;
    font-size:.85rem;
    padding:.55rem .9rem;
    border-radius:.7rem;
    cursor:pointer;
    transition:transform .15s ease, box-shadow .15s ease;
  }
  .btn:hover{ transform:translateY(-1px); box-shadow:0 6px 14px rgba(56,189,248,.2); }
  .btnPrimary{
    background:#0ea5e9;
    border-color:#0ea5e9;
    color:#fff;
  }

  /* Address picker */
  .addrBox{ margin-bottom:1rem; }
  .addrBox .row{ display:flex; gap:.5rem; align-items:center; margin-bottom:.5rem; }
  .addrBox label{ font-size:.75rem; color:var(--text-muted); display:block; margin-bottom:.35rem; }
  #addrSearch,#placeCode{ flex:1; background:#fff; border:1px solid var(--panel-strong); border-radius:var(--radius-md); color:var(--text); font-family:var(--mono); font-size:.9rem; padding:.35rem .5rem; outline:none; }
  #addrSearch:focus,#placeCode:focus{ border-color:var(--accent); box-shadow:0 0 16px rgba(56,189,248,.35); }
  #placeCode{ width:140px; }
  .addrList{ max-height:160px; overflow:auto; border:1px solid var(--panel-strong); border-radius:var(--radius-md); background:#fff; }
  .addrItem{ padding:.5rem; border-bottom:1px solid rgba(148,163,184,.15); font-size:.74rem; cursor:pointer; color:var(--text); }
  .addrItem:hover{ background:rgba(56,189,248,.08); }
  .addrHint{ font-size:.7rem; color:var(--text-muted); margin-top:.35rem; }

  /* Small cards */
  .minigrid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(min(260px,100%),1fr)); gap:.75rem; }
  .cardHeader{ font-size:.7rem; color:var(--text-muted); font-weight:700; margin-bottom:.5rem; }
  .cardBody{ font-family:var(--mono); font-size:1.72rem; line-height:1.4; color:var(--text); white-space:pre-wrap; word-break:break-word; }
  #debugLog{ display:none; background:#fff5f5; border:1px solid rgba(248,113,113,.4); color:#b91c1c; font-family:var(--mono); font-size:.7rem; line-height:1.4; border-radius:var(--radius-md); padding:.75rem; margin-top:1rem; max-height:180px; overflow:auto; white-space:pre-wrap; }

  /* RIGHT */
  .rightPane{
    padding:1.25rem;
    display:flex;
    flex-direction:column;
    background:radial-gradient(circle at 50% 0%, rgba(56,189,248,.12) 0%, rgba(255,255,255,0) 70%), linear-gradient(to bottom right, rgba(255,255,255,.9), rgba(241,245,249,.6));
  }
  .sectionTitle{ font-size:.82rem; color:var(--text); font-weight:700; display:flex; justify-content:space-between; gap:.5rem 1rem; margin-bottom:.6rem; }
  #modeToggle{
    border:1px solid rgba(56,189,248,.5);
    background:var(--accent-soft);
    color:#0c4a6e;
    font-weight:700;
    font-size:.75rem;
    padding:.35rem .6rem;
    border-radius:.55rem;
    cursor:pointer;
  }
  .statusChip{ font-size:.7rem; background:var(--panel-muted); border:1px solid var(--panel-strong); border-radius:var(--radius-md); padding:.35rem .5rem; color:var(--text-muted); }
  .summaryCard{ background:var(--panel); border:1px solid var(--panel-strong); border-radius:var(--radius-md); padding:.75rem; margin-bottom:.8rem; font-family:var(--mono); font-size:.7rem; line-height:1.4; color:#0c4a6e; white-space:pre-wrap; word-break:break-word; max-height:240px; overflow:auto; }
  .waybillSheetPreview{ background:#fff; color:#000; border-radius:var(--radius-md); padding:.75rem; font-family:var(--mono); font-size:.72rem; line-height:1.4; min-height:180px; overflow:auto; }

  /* ===== PRINT LOCK (100×150mm exact) ===== */
  @media print{
    @page{ size:100mm 150mm; margin:0; }
    html,body{ margin:0!important; padding:0!important; }
    .shell{ display:none!important; }
    .printSheetWrapper{ display:block!important; }
    .wb100x150{
      width:calc(100mm / var(--print-scale))!important;
      height:calc(150mm / var(--print-scale))!important;
      transform:scale(var(--print-scale)); transform-origin:top left;
      page-break-after:always; break-inside:avoid; overflow:hidden; background:#fff;
    }
    img{ print-color-adjust:exact; -webkit-print-color-adjust:exact; }
  }

  .printSheetWrapper{ display:none; padding:0; }
  .wbPreviewZoom{ display:inline-block; transform:scale(.6); transform-origin:top left; }

  /* ===== Waybill rubric (grid canvas) ===== */
  .wb100x150{
    box-sizing:border-box; padding:3mm 3.5mm; color:#000; font-family:var(--mono);
    display:grid; grid-template-rows:18mm auto 52mm; row-gap:2mm;
  }
  .wbHead{ display:grid; grid-template-columns:1fr auto; grid-template-rows:auto auto 1fr; column-gap:3mm; row-gap:1mm; }
  .wbHeadTitle{ grid-column:1/2; grid-row:1; font-size:3.6mm; line-height:1.2; font-weight:700; }
  .wbSvcImg{ grid-column:2/3; grid-row:1/span 3; justify-self:end; align-self:start; display:inline-flex; align-items:center; justify-content:center; padding:.5mm 1mm; overflow:hidden; }
  .wbSvcFallback{ font-weight:700; font-size:3mm; letter-spacing:.2mm; }
 .wbTopCode svg{
  max-width:100%;
  height:auto;
  display:block;
}
.wbTopCode{ grid-column:1/2; grid-row:1; display:flex; flex-direction:column; align-items:left; gap:0mm; }
  .wbTopHuman{ font-size:4.2mm; font-weight:700; }

  .wbBody{ display:grid;  gap:2mm 3mm; margin-top:2mm; }
  .wbFrom,.wbTo{ border:1px solid #000; border-radius:1mm; padding:2mm; font-size:3mm; line-height:1.32; background:#fff; }
  .wbTo{ background:#f7f7f7; }
  .wbBigCode{ grid-column:1/-1; border:1px solid #000; border-radius:1mm; padding:2mm; display:grid; grid-template-rows:auto 1fr auto; row-gap:1mm; }
  .wbBigHuman{ font-size:3.6mm; font-weight:700; text-align:center; }
  .wbBigCode svg{ width:100%; height:15mm; display:block; }
  .wbMetaRow{ display:flex; justify-content:space-between; font-size:3mm; }
  .wbFoot{ border-top:1px dashed #000; padding-top:2mm; display:grid; grid-template-columns:1fr; grid-auto-rows:minmax(0,1fr); row-gap:2mm; }
  .podBox{ border:1px solid #000; border-radius:1mm; padding:2mm; font-size:3.2mm; line-height:1.35; display:grid; grid-template-rows:auto auto auto auto; row-gap:2mm; margin:0 auto; width:300px; }
  .podTitle{  font-size: 12px; font-weight:700; }

/* === DISPATCH BOARD VIEW === */
#dispatchBoardContainer {
  width:100%;
  display:flex;
  flex-direction:column;
  gap:.85rem;
  padding:1.25rem;
  border-radius:var(--radius-lg);
  background:rgba(255,255,255,.92);
  border:1px solid var(--panel-strong);
  box-shadow:0 24px 60px rgba(15,23,42,.1);
}

.dispatchStatusPanel {
  display:flex;
  flex-direction:column;
  gap:.6rem;
  padding:.85rem 1rem;
  border-radius:var(--radius-lg);
  border:1px solid var(--panel-strong);
  background:linear-gradient(120deg, rgba(255,255,255,.96), rgba(224,231,255,.45));
  box-shadow:0 18px 40px rgba(15,23,42,.08);
}
.dispatchStatusHeader {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:.75rem;
}
.dispatchStatusHeader h3{
  font-size:.9rem;
  margin:0;
  color:#0f172a;
}
.dispatchStatusLabel{
  font-size:.72rem;
  padding:.25rem .6rem;
  border-radius:999px;
  border:1px solid rgba(251,191,36,.5);
  background:rgba(251,191,36,.18);
  color:#92400e;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:.05em;
}
.dispatchProgressBar{
  position:relative;
  height:18px;
  border-radius:999px;
  overflow:hidden;
  background:linear-gradient(90deg, rgba(254,240,138,.7), rgba(251,191,36,.2));
  border:1px solid rgba(250,204,21,.65);
}
.dispatchProgressBar.is-pulse{
  animation:dispatchPulse .6s ease;
}
.dispatchProgressFill{
  position:absolute;
  inset:0;
  width:0%;
  background:linear-gradient(90deg, #f97316, #facc15, #22d3ee);
  box-shadow:0 0 14px rgba(251,191,36,.7);
  transition:width .5s ease;
}
.dispatchProgressSun{
  position:absolute;
  top:50%;
  right:12px;
  transform:translateY(-50%);
  width:26px;
  height:26px;
  border-radius:50%;
  background:radial-gradient(circle, rgba(254,240,138,.95), rgba(251,191,36,.95), rgba(249,115,22,.9));
  box-shadow:0 0 20px rgba(251,191,36,.85);
  pointer-events:none;
}
.dispatchProgressSteps{
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(110px, 1fr));
  gap:.35rem .6rem;
  font-size:.7rem;
  color:#334155;
}
.dispatchProgressStep{
  display:flex;
  align-items:center;
  gap:.35rem;
  padding:.25rem .4rem;
  border-radius:.5rem;
  border:1px solid var(--panel-strong);
  background:#fff;
}
.dispatchProgressDot{
  width:.55rem;
  height:.55rem;
  border-radius:50%;
  background:#cbd5f5;
}
.dispatchProgressStep.is-active{
  border-color:rgba(56,189,248,.8);
  background:rgba(56,189,248,.12);
  color:#0c4a6e;
}
.dispatchProgressStep.is-active .dispatchProgressDot{
  background:#38bdf8;
  box-shadow:0 0 10px rgba(56,189,248,.8);
}
.dispatchProgressStep.is-complete{
  border-color:rgba(34,197,94,.7);
  background:rgba(34,197,94,.12);
  color:#065f46;
}
.dispatchProgressStep.is-complete .dispatchProgressDot{
  background:#22c55e;
  box-shadow:0 0 10px rgba(34,197,94,.65);
}
@keyframes dispatchPulse{
  0%{ transform:scaleX(1); }
  50%{ transform:scaleX(1.02); }
  100%{ transform:scaleX(1); }
}

.dispatchLogPanel{
  border:1px solid var(--panel-strong);
  border-radius:var(--radius-lg);
  background:#fff;
  padding:.75rem 1rem;
  box-shadow:0 14px 32px rgba(15,23,42,.08);
}
.dispatchLogHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  font-size:.8rem;
  font-weight:700;
  color:#0f172a;
  margin-bottom:.4rem;
}
.dispatchLog{
  max-height:180px;
  overflow:auto;
  font-size:.72rem;
  color:#1f2937;
  line-height:1.4;
}
.dispatchLogEntry{
  padding:.35rem .25rem;
  border-bottom:1px dashed rgba(226,232,240,.9);
  display:flex;
  gap:.5rem;
  align-items:flex-start;
}
.dispatchLogEntry:last-child{
  border-bottom:none;
}
.dispatchLogEntry span{
  font-family:var(--mono);
  color:#64748b;
  min-width:75px;
}

/* lanes across the screen */
#dispatchBoardGrid {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 1rem;
  padding: .35rem;
  min-height: 62vh;
  overflow-y: auto;
  background: radial-gradient(circle at 30% 20%, rgba(56,189,248,0.1), transparent 60%);
}
@media (max-width:1100px){
  #dispatchBoardGrid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
}
@media (max-width:700px){
  #dispatchBoardGrid { grid-template-columns: 1fr; }
}

/* column headers */
.dispatchColHeader {
  font-size: .9rem;
  font-weight: 700;
  color: #0284c7;
  margin-bottom: 0.4rem;
  text-transform: uppercase;
  letter-spacing: 0.6px;
}

/* cards in columns */
.dispatchCard {
  background: #ffffff;
  border: 1px solid var(--panel-strong);
  border-radius: 10px;
  padding: 0.6rem 0.65rem;
  margin-bottom: 0.6rem;
  box-shadow: 0 2px 6px rgba(15,23,42,0.08);
  transition: transform 0.15s ease, box-shadow 0.15s ease;
}

.dispatchCard:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 14px rgba(56,189,248,0.18);
}

.dispatchCardTitle {
  font-weight: 600;
  font-size: 0.85rem;
  color: var(--text);
  margin-bottom: 0.2rem;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  line-clamp: 2;
  overflow: hidden;
  word-break: break-word;
}

.dispatchCardMeta {
  font-size: 0.68rem;
  color: var(--text-muted);
  margin-bottom: 0.35rem;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}


  .dispatchCardLines {
    font-size: 0.72rem;
    color: #334155;
    line-height: 1.25;
    white-space: pre-line;
    display:-webkit-box;
    -webkit-line-clamp:4;
    line-clamp:4;
    -webkit-box-orient:vertical;
    overflow:hidden;
    word-break:break-word;
  }

  .dispatchCardActions{
    display:flex;
    justify-content:flex-end;
    flex-wrap:wrap;
    gap:.35rem;
    margin-top:.5rem;
  }

  .dispatchPackBtn{
    border:1px solid rgba(59,130,246,.4);
    background:rgba(59,130,246,.12);
    color:#1d4ed8;
    font-size:.7rem;
    font-weight:700;
    padding:.35rem .55rem;
    border-radius:.5rem;
    cursor:pointer;
  }
  .dispatchPackBtn:hover{
    background:rgba(59,130,246,.2);
  }
  .dispatchPackBtn:disabled{
    opacity:.5;
    cursor:not-allowed;
  }

  .dispatchBookBtn{
    border:1px solid rgba(56,189,248,.45);
    background:rgba(56,189,248,.12);
    color:#0c4a6e;
    font-size:.7rem;
    font-weight:700;
    padding:.35rem .55rem;
    border-radius:.5rem;
    cursor:pointer;
  }

  .dispatchBookBtn:hover{
    background:rgba(56,189,248,.22);
  }
  .dispatchBookBtn:disabled{
    opacity:.5;
    cursor:not-allowed;
  }
  .dispatchNoteBtn{
    border:1px solid rgba(34,197,94,.55);
    background:rgba(34,197,94,.16);
    color:#065f46;
    font-size:.7rem;
    font-weight:700;
    padding:.35rem .55rem;
    border-radius:.5rem;
    cursor:pointer;
  }
  .dispatchNoteBtn:hover{
    background:rgba(34,197,94,.26);
  }

  .dispatchPackingPanel{
    border-top:1px dashed rgba(148,163,184,.5);
    margin-top:.6rem;
    padding-top:.6rem;
    display:none;
  }
  .dispatchPackingPanel.is-active{
    display:block;
  }
  .dispatchPackingHeader{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:.5rem;
    margin-bottom:.45rem;
  }
  .dispatchPackingTitle{
    font-size:.78rem;
    font-weight:700;
    color:#0f172a;
  }
  .dispatchPackingTimes{
    font-size:.62rem;
    color:#64748b;
    display:flex;
    flex-direction:column;
    gap:.2rem;
    text-align:right;
  }
  .dispatchPackingList{
    display:flex;
    flex-direction:column;
    gap:.45rem;
    margin-bottom:.5rem;
  }
  .dispatchPackingRow{
    border:1px solid rgba(226,232,240,.9);
    border-radius:.5rem;
    padding:.4rem .5rem;
    background:#f8fafc;
  }
  .dispatchPackingRow.is-complete{
    background:rgba(148,163,184,.12);
  }
  .dispatchPackingRow.is-complete .dispatchPackingItem{
    text-decoration:line-through;
    color:#94a3b8;
  }
  .dispatchPackingInfo{
    display:flex;
    flex-direction:column;
    gap:.15rem;
  }
  .dispatchPackingItem{
    font-size:.74rem;
    font-weight:600;
    color:#0f172a;
  }
  .dispatchPackingMeta{
    font-size:.64rem;
    color:#475569;
  }
  .dispatchPackingActions{
    display:flex;
    flex-wrap:wrap;
    gap:.35rem;
    margin-top:.35rem;
  }
  .dispatchPackingQty{
    width:60px;
    border-radius:.4rem;
    border:1px solid rgba(148,163,184,.6);
    padding:.2rem .3rem;
    font-size:.7rem;
  }
  .dispatchPackQtyBtn,
  .dispatchPackAllBtn{
    border-radius:.4rem;
    border:1px solid rgba(59,130,246,.3);
    background:rgba(59,130,246,.08);
    color:#1e3a8a;
    font-size:.66rem;
    padding:.25rem .45rem;
    cursor:pointer;
  }
  .dispatchPackQtyBtn:hover,
  .dispatchPackAllBtn:hover{
    background:rgba(59,130,246,.16);
  }
  .dispatchPackQtyBtn:disabled,
  .dispatchPackAllBtn:disabled{
    opacity:.5;
    cursor:not-allowed;
  }
  .dispatchPackingFooter{
    display:flex;
    flex-direction:column;
    gap:.45rem;
  }
  .dispatchParcelScan{
    display:flex;
    gap:.35rem;
  }
  .dispatchParcelInput{
    flex:1;
    border-radius:.45rem;
    border:1px solid rgba(148,163,184,.6);
    padding:.3rem .45rem;
    font-size:.7rem;
  }
  .dispatchParcelAddBtn{
    border-radius:.45rem;
    border:1px solid rgba(16,185,129,.35);
    background:rgba(16,185,129,.12);
    color:#065f46;
    font-size:.65rem;
    font-weight:700;
    padding:.3rem .45rem;
    cursor:pointer;
  }
  .dispatchParcelAddBtn:hover{
    background:rgba(16,185,129,.2);
  }
  .dispatchParcelList{
    display:flex;
    flex-wrap:wrap;
    gap:.25rem;
    font-size:.62rem;
    color:#0f172a;
  }
  .dispatchParcelList span{
    background:rgba(56,189,248,.14);
    border:1px solid rgba(56,189,248,.3);
    padding:.2rem .35rem;
    border-radius:.4rem;
  }
  .dispatchParcelEmpty{
    color:#94a3b8;
    border:none;
    background:none;
    padding:0;
  }
  .dispatchPackingControls{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:.5rem;
  }
  .dispatchPackingCount{
    font-size:.65rem;
    color:#475569;
  }
  .dispatchFinishPackingBtn{
    border-radius:.45rem;
    border:1px solid rgba(234,88,12,.35);
    background:rgba(251,146,60,.15);
    color:#9a3412;
    font-size:.65rem;
    font-weight:700;
    padding:.3rem .55rem;
    cursor:pointer;
  }
  .dispatchFinishPackingBtn:hover{
    background:rgba(251,146,60,.24);
  }
  .dispatchFinishPackingBtn:disabled{
    opacity:.55;
    cursor:not-allowed;
  }
  .dispatchPackingEmpty{
    font-size:.65rem;
    color:#94a3b8;
  }

.dispatchColBody {
  overflow-y: auto;
  max-height: 62vh;
  padding-right: 6px;
}

/* lane separation */
.dispatchCol {
  display: flex;
  flex-direction: column;
  background: rgba(241,245,249,0.9);
  border-radius: 12px;
  padding: 0.85rem;
  border: 1px solid var(--panel-strong);
}

.dispatchBoardEmpty {
  grid-column: 1 / -1;
  text-align: center;
  font-size: 0.8rem;
  color: var(--text-muted);
  padding: 1rem 0;
}

.dispatchBoardEmptyCol {
  font-size: 0.72rem;
  color: #94a3b8;
  padding: 0.35rem 0.1rem;
}

  .dispatchStamp{
  font-size:.7rem;
  color:var(--text-muted);
  font-family:var(--mono);
}

  /* Documentation */
  .docsShell{
    max-width:980px;
    margin:0 auto;
    background:rgba(255,255,255,.96);
    border:1px solid var(--panel-strong);
    border-radius:var(--radius-lg);
    box-shadow:0 30px 80px rgba(15,23,42,.12);
    padding:1.5rem;
  }
  .docsShell h2{
    font-size:1rem;
    margin:1.25rem 0 .5rem;
  }
  .docsShell h3{
    font-size:.9rem;
    margin:1rem 0 .4rem;
  }
  .docsShell p,
  .docsShell li{
    font-size:.85rem;
    color:var(--text);
    line-height:1.5;
  }
  .docsGrid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(min(280px,100%),1fr));
    gap:1rem;
  }
  .docsCard{
    border:1px solid var(--panel-strong);
    border-radius:var(--radius-md);
    padding:1rem;
    background:var(--panel);
  }
  .docsMeta{
    font-family:var(--mono);
    font-size:.78rem;
    color:var(--text-muted);
  }
  .docsCode{
    font-family:var(--mono);
    font-size:.78rem;
    background:var(--panel-muted);
    border:1px dashed var(--panel-strong);
    padding:.5rem .6rem;
    border-radius:var(--radius-md);
    color:#0c4a6e;
  }
  .pill{
    display:inline-flex;
    align-items:center;
    gap:.35rem;
    padding:.2rem .5rem;
    border-radius:999px;
    border:1px solid rgba(56,189,248,.5);
    background:var(--accent-soft);
    color:#0c4a6e;
    font-size:.7rem;
    font-weight:600;
  }
  .parcelNumbersPanel{
    background:linear-gradient(145deg, rgba(15,23,42,.04), rgba(148,163,184,.1));
    border:1px solid var(--panel-strong);
    border-radius:var(--radius-lg);
    padding:1rem;
    min-height:320px;
    display:flex;
    flex-direction:column;
    gap:.75rem;
  }
  .parcelNumbersHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    font-weight:700;
    color:var(--text);
  }
  .parcelNumbersSub{
    font-size:.78rem;
    color:var(--text-muted);
  }
  .parcelNumbersGrid{
    display:grid;
    grid-template-columns:repeat(auto-fill, minmax(80px, 1fr));
    gap:.75rem;
  }
  .parcelNumber{
    display:grid;
    place-items:center;
    font-size:2.1rem;
    font-weight:800;
    border-radius:1rem;
    min-height:80px;
    background:#fff;
    border:2px dashed rgba(148,163,184,.5);
    color:#94a3b8;
    transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease;
  }
  .parcelNumber.is-scanned{
    border-style:solid;
    border-color:rgba(34,197,94,.6);
    color:#16a34a;
    box-shadow:0 10px 25px rgba(34,197,94,.15);
    background:rgba(240,253,244,.9);
    transform:translateY(-2px);
  }
  .parcelNumbersEmpty{
    color:var(--text-muted);
    font-size:.9rem;
    padding:1.5rem 0;
    text-align:center;
  }

</style>
</head>
 <body>
  <div class="flApp">
    <nav class="flNav" aria-label="Primary">
      <div class="flNavTitle">Flippen Lekka Operations</div>
      <div class="flNavGroup" role="tablist" aria-label="Primary views">
        <button id="navScan" class="flNavBtn flNavBtn--active" type="button" role="tab" aria-controls="viewScan" aria-selected="true">Scan Station</button>
        <button id="navOps" class="flNavBtn" type="button" role="tab" aria-controls="viewOps" aria-selected="false">Dispatch Board</button>
        <button id="navDocs" class="flNavBtn" type="button" role="tab" aria-controls="viewDocs" aria-selected="false">Documentation</button>
        <a class="flNavBtn" href="/flocs">Order capture (FLOCS)</a>
        <a class="flNavBtn" href="/stock.html">Stock take</a>
      </div>
      <div class="flNavStatus">
        <span id="statusChip" class="statusChip">Ready to scan orders…</span>
        <span id="actionFlash" class="actionFlash">Ready to scan orders…</span>
      </div>
    </nav>

    <div class="flView flView--active" id="viewScan">
      <div class="shell" role="application" aria-label="Flippen Lekka Scan Station">
  <!-- LEFT -->
  <section class="leftPane">
    <div class="headerRow">
      <div class="line1">Flippen Lekka Scan Station <span class="badge" aria-live="polite">v0.3</span></div>
      <div class="sessionInfo" aria-live="polite">
        <div>Order: <span id="uiOrderNo">--</span></div>
        <div>Session mode: <span id="uiSessionMode">Waiting</span></div>
        <div>Parcels: <span id="uiParcelCount">0</span> / <span id="uiExpectedCount">--</span></div>
        <div>Parcel source: <span id="uiParcelSource">--</span></div>
        <div>Auto-book: <span id="uiAutoBook">Idle</span></div>
      
      </div>
    </div>

    <!-- Scanner input -->
    <div class="scanBox">
      <label for="scanInput"><span>Scan parcel sticker barcode</span><small>Example: 252051001</small></label>
      <input id="scanInput" type="text" inputmode="numeric" autocomplete="off" placeholder="Focus here. Scanner types then Enter." aria-describedby="scanHelp" />
      <div id="scanHelp" class="addrHint"><br>HOW IT WORKS: 
      <ul>
        <li>An order can only be booked once. Once a shipment was successfully created for an order, a manual override is needed.</li>
        <li>There is a 6 second timer that starts to run after each scan and resets on each new scan. When that timer runs out, the system proceeds with booking the shipment. Then resets the session, ready for a new scan</li>
     <li>
      </ul></div>
      <!-- Add this somewhere in your Scan view controls -->
<button id="btnBookNow" class="btn btnPrimary" hidden>BOOK NOW</button>

    </div>

    <!-- Address search/select (toggle display if needed) -->
    <div class="addrBox" id="addrBox" hidden>
      <label>Destination address <span class="addrHint" style="font-weight:400">(search & select)</span></label>
      <div class="row">
        <input id="addrSearch" type="text" placeholder="Type name, city, postal, street…" />
        <input id="placeCode" type="text" placeholder="place code" title="ParcelPerfect place code (optional)" />
      </div>
      <div class="addrList" id="addrResults" role="listbox" aria-label="Address results"></div>
      <div class="addrHint">Tip: selecting an item sets the destination and its place code (if present). You can paste a code too.</div>
    </div>

    <!-- Service override (toggle display if needed) -->
    <div class="card" id="svcBox" hidden>
      <div class="cardHeader">Service</div>
      <div class="svcRow">
        <label for="serviceOverride" class="addrHint" style="font-size:.8rem">Prefer:</label>
        <select id="serviceOverride" title="Choose a service or Auto">
          <option value="AUTO">Auto (RFX→ECO→RDF→first)</option>
          <option value="RFX">RFX (Road Express)</option>
          <option value="ECO">ECO (Economy Road)</option>
          <option value="RDF" selected>RDF (Roadfreight)</option>
          <option value="ONX">ONX (Overnight Air)</option>
          <option value="OVN">OVN (Overnight 2)</option>
          <option value="CSS">CSS (ChainStores)</option>
        </select>
      </div>
    </div>

    <!-- Info cards -->
    <div class="minigrid">
      <div class="card"><div class="cardHeader">Scanned Parcel Details</div><div class="cardBody" id="parcelList">No parcels scanned yet.</div></div>
      <div class="card"><div class="cardHeader">Ship To</div><div class="cardBody" id="shipToCard">None yet.</div></div>
      
        <div id="last-booking" class="card">
  <div class="card-title">Last Booking Status</div>
  <div id="last-booking-body"></div>
      </div>
    </div>

    <div id="debugLog" aria-live="polite"></div>
  </section>

  <!-- RIGHT -->
  <section class="rightPane">

    <div class="sectionTitle" style="margin-top:.8rem">
    <button id="modeToggle" type="button">MODE: AUTO</button>

    </div>
    <div class="parcelNumbersPanel" aria-live="polite">
      <div class="parcelNumbersHeader">
        <span>Parcel Numbers</span>
        <span class="parcelNumbersSub">Large scan confirmation</span>
      </div>
      <div id="parcelNumbers" class="parcelNumbersGrid">
        <div class="parcelNumbersEmpty">Scan an order to show parcel numbers.</div>
      </div>
    </div>
  </section>
</div>
    </div>

    <div class="flView" id="viewOps" hidden>
      <div id="dispatchBoardContainer">
        <div class="dispatchStatusPanel" aria-live="polite">
          <div class="dispatchStatusHeader">
            <h3>Booking progress</h3>
            <span id="dispatchProgressLabel" class="dispatchStatusLabel">Idle</span>
          </div>
          <div class="dispatchProgressBar" id="dispatchProgressBar">
            <div id="dispatchProgressFill" class="dispatchProgressFill"></div>
            <div class="dispatchProgressSun" aria-hidden="true"></div>
          </div>
          <div class="dispatchProgressSteps" id="dispatchProgressSteps"></div>
        </div>
        <div class="dispatchLogPanel">
          <div class="dispatchLogHeader">
            <span>Dispatch log</span>
            <span class="dispatchStamp">Latest activity</span>
          </div>
          <div id="dispatchLog" class="dispatchLog" aria-live="polite"></div>
        </div>
        <div class="dispatchBoardPanel">
          <div class="sectionTitle" style="margin-top:.4rem">
            <span>Dispatch Whiteboard</span>
            <span id="dispatchStamp" class="dispatchStamp">–</span>
          </div>
          <div class="dispatchBoard" id="dispatchBoardGrid">
            <div class="dispatchBoardEmpty">Loading open orders…</div>
          </div>
        </div>
      </div>
    </div>

    <div class="flView" id="viewDocs" hidden>
      <div class="docsShell">
        <div class="pill">Operator Guide</div>
        <h2>Scan Station Overview</h2>
        <p>This console books shipments automatically based on scanned parcel labels and Shopify order metadata. The session banner shows the active order, mode, expected parcel count, and auto-book countdown so operators can confirm readiness before booking.</p>

        <div class="docsGrid">
          <div class="docsCard">
            <h3>Quick Start (Daily Use)</h3>
            <ol>
              <li>Open the Scan Station view and keep the cursor in the scan field.</li>
              <li>Scan parcel barcodes in order; the session panel will show scanned vs expected parcels.</li>
              <li>Use the <strong>MODE</strong> toggle to switch between Auto (tag/idle booking) and Manual (tap Book Now).</li>
              <li>If a <span class="pill">parcel_count_#</span> tag exists, the booking is triggered on the first scan.</li>
              <li>If no tag exists, the system auto-books after the idle timer expires or you can tap <strong>BOOK NOW</strong>.</li>
              
          </div>
         
        </div>

        <h2>Dispatch Board</h2>
        <p>The Dispatch Board groups open Shopify orders by urgency. Each card lists customer details, service code, tags, and a parcel count indicator so planners can prioritize packing.</p>
        <p>Tap <strong>Book Now</strong> on a card to enter the number of boxes and immediately book the shipment for that order.</p>

        <h2>Mobile Access (Same Network)</h2>
        <p>To access the app from a phone or tablet on the same Wi-Fi, the server must listen on all interfaces and allow the phone's origin.</p>
        <div class="docsCard">
          <h3>Step-by-Step</h3>
          <ol>
            <li>Find the computer's IP address on your network (example: <span class="docsCode">192.168.1.25</span>).</li>
            <li>Start the server with <span class="docsCode">HOST=0.0.0.0</span>.</li>
            <li>Set <span class="docsCode">FRONTEND_ORIGIN</span> to include both desktop and mobile origins (comma-separated), or use <span class="docsCode">*</span> for local testing.</li>
            <li>On the phone, open <span class="docsCode">http://192.168.1.25:3000</span>.</li>
          </ol>
          <p class="docsMeta">Tip: If you see a CORS error, update <span class="docsCode">FRONTEND_ORIGIN</span> to include the mobile address.</p>
        </div>

        <h2>Endpoints</h2>
        <div class="docsGrid">
          <div class="docsCard">
            <h3>Core API</h3>
            <ul>
              <li><span class="docsCode">POST /pp</span> — ParcelPerfect proxy for bookings and quotes.</li>
              <li><span class="docsCode">GET /shopify/orders/by-name/:name</span> — Order lookup by Shopify name.</li>
              <li><span class="docsCode">GET /shopify/orders/open</span> — Dispatch board feed.</li>
              <li><span class="docsCode">POST /shopify/fulfill</span> — Fulfillment + tracking update.</li>
              <li><span class="docsCode">GET /healthz</span> — Service health check.</li>
            </ul>
          </div>
          <div class="docsCard">
            <h3>Operator Tips</h3>
            <ul>
              <li>Use <strong>Emergency Stop</strong> to clear the session if the wrong order is scanned.</li>
              <li>If an order is already booked, scans are blocked to prevent duplicates.</li>
              <li>Keep labels flat in the printer; the preview matches the 100×150mm output.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- PRINT-ONLY MOUNT -->
<div class="printSheetWrapper"><div id="printMount"></div></div>

<script src="/app.js"></script>
</body> 
</html>
