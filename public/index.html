<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Flippen Lekka Scan Station ‚Äî v5 (cleaned + 100√ó150 print lock)</title>
<style>
  :root{
    --bg:#f5f7fb;
    --panel:#ffffff;
    --panel-muted:#f1f5f9;
    --panel-strong:#e2e8f0;
    --text:#0b1324;
    --text-muted:#5b6b7f;
    --accent:#6366f1;
    --accent-strong:#22d3ee;
    --accent-2:#f97316;
    --accent-3:#a855f7;
    --accent-soft:rgba(99,102,241,.12);
    --radius-lg:1rem;
    --radius-md:.7rem;
    --mono:ui-monospace,SFMono-Regular,Consolas,"Liberation Mono",Menlo,monospace;
    --sans:-apple-system,BlinkMacSystemFont,"Inter",Roboto,"Segoe UI",system-ui,sans-serif;
    --shadow-soft:0 18px 40px rgba(15,23,42,.08);
    --shadow-strong:0 24px 60px rgba(15,23,42,.12);
    --print-scale:1.0; /* safe inner scaling for printers that overscan */
  }
  *{box-sizing:border-box}
  body{
    background:var(--bg);
    color:var(--text);
    font-family:var(--sans);
    min-height:100dvh;
    margin:0;
  }
  .flApp{
    min-height:100dvh;
    display:flex;
    flex-direction:column;
    gap:1rem;
    padding:1.25rem 1.75rem 1.75rem;
  }
  @media (max-width:800px){
    .flApp{ padding:1rem; gap:1rem; }
  }
  .flLayout{
    display:flex;
    align-items:stretch;
    gap:1rem;
    flex:1;
    min-height:calc(100dvh - 2rem);
  }
  @media (max-width:900px){
    .flLayout{ flex-direction:column; }
  }
  .flSide{
    background:var(--panel);
    border:1px solid var(--panel-strong);
    box-shadow:var(--shadow-soft);
    border-radius:var(--radius-lg);
    padding:1rem .9rem;
    display:flex;
    flex-direction:column;
    gap:1rem;
    min-width:220px;
    max-width:260px;
    backdrop-filter:blur(12px);
  }
  .flSideHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:.75rem;
  }
  .flHamburger{
    width:36px;
    height:36px;
    border-radius:.65rem;
    border:1px solid rgba(99,102,241,.2);
    background:var(--panel);
    display:inline-flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    transition:border-color .2s ease, box-shadow .2s ease;
  }
  .flHamburger:hover{
    border-color:rgba(99,102,241,.5);
    box-shadow:0 8px 18px rgba(99,102,241,.18);
  }
  .flHamburgerLines{
    position:relative;
    width:16px;
    height:12px;
  }
  .flHamburgerLines::before,
  .flHamburgerLines::after,
  .flHamburgerLines span{
    content:"";
    position:absolute;
    left:0;
    right:0;
    height:2px;
    border-radius:999px;
    background:var(--text);
  }
  .flHamburgerLines::before{ top:0; }
  .flHamburgerLines span{ top:5px; }
  .flHamburgerLines::after{ bottom:0; }
  .flNav{
    display:flex;
    flex-direction:column;
    gap:1rem;
  }
  .flNavTitle{
    font-weight:700;
    letter-spacing:.02em;
    color:#1f2a44;
    font-size:.95rem;
  }
  .flNavGroup{
    display:flex;
    flex-direction:column;
    gap:.65rem;
  }
  .flNavBtn{
    border:1px solid var(--panel-strong);
    background:var(--panel);
    color:var(--text);
    font-weight:600;
    font-size:.85rem;
    padding:.55rem .9rem;
    border-radius:.75rem;
    cursor:pointer;
    transition:all .2s ease;
    text-decoration:none;
    display:inline-flex;
    align-items:center;
    width:100%;
    justify-content:flex-start;
    gap:.5rem;
  }
  .flNavBtnIcon{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:1.2rem;
    font-size:1rem;
  }
  .flNavBtn:hover{
    border-color:rgba(99,102,241,.45);
    color:#4338ca;
    transform:translateY(-1px);
    box-shadow:0 8px 18px rgba(67,56,202,.12);
  }
  .flNavBtn--active{
    background:linear-gradient(130deg, var(--accent), var(--accent-strong));
    border-color:transparent;
    color:#0f172a;
    box-shadow:0 12px 30px rgba(67,56,202,.25);
  }
  .flNavStatus{
    display:flex;
    align-items:center;
    gap:.6rem;
    flex-wrap:wrap;
  }
  .flMain{
    flex:1;
    display:flex;
    flex-direction:column;
    gap:1rem;
  }
  body.flNavCollapsed .flSide{
    min-width:64px;
    max-width:64px;
    padding:.85rem .5rem;
  }
  body.flNavCollapsed .flNavTitle,
  body.flNavCollapsed .flNavBtnText,
  body.flNavCollapsed .flNavStatus{
    display:none;
  }
  body.flNavCollapsed .flNavBtn{
    justify-content:center;
    padding:.5rem;
  }
  body.flNavCollapsed .flNavGroup{
    align-items:center;
  }
  @media (max-width:900px){
    body.flNavCollapsed .flSide{
      max-width:none;
      min-width:0;
      width:100%;
      padding:.65rem .75rem;
      gap:.5rem;
    }
    body.flNavCollapsed .flNavTitle{
      display:block;
    }
    body.flNavCollapsed .flNavGroup,
    body.flNavCollapsed .flNavStatus{
      display:none;
    }
  }
  .actionFlash{
    font-size:.72rem;
    color:var(--text-muted);
    background:var(--panel-muted);
    border:1px solid var(--panel-strong);
    border-radius:var(--radius-md);
    padding:.3rem .55rem;
    opacity:.75;
    transition:opacity .2s ease;
  }
  .actionFlash--ok{ border-color:rgba(34,197,94,.55); color:#bbf7d0; }
  .actionFlash--warn{ border-color:rgba(251,191,36,.6); color:#fde68a; }
  .actionFlash--err{ border-color:rgba(248,113,113,.6); color:#fecaca; }
  .actionFlash--booked{
    color:#052e16;
    border-color:rgba(34,197,94,.85);
    background:linear-gradient(120deg, rgba(34,197,94,.9), rgba(74,222,128,.8));
    box-shadow:0 0 24px rgba(34,197,94,.55);
    animation:bookedFlash 1.2s ease-in-out 2;
  }
  @keyframes bookedFlash{
    0%{ transform:scale(1); opacity:.7; }
    35%{ transform:scale(1.06); opacity:1; }
    70%{ transform:scale(1); opacity:.85; }
    100%{ transform:scale(1); opacity:.7; }
  }
  .screenFlash{
    position:fixed;
    inset:0;
    pointer-events:none;
    opacity:0;
    z-index:999;
    mix-blend-mode:screen;
  }
  .screenFlash--success{
    background:rgba(34,197,94,.35);
    animation:screenFlash 0.65s ease;
  }
  .screenFlash--failure{
    background:rgba(248,113,113,.4);
    animation:screenFlash 0.65s ease;
  }
  .screenFlash--warn{
    background:rgba(249,115,22,.35);
    animation:screenFlash 0.65s ease;
  }
  @keyframes screenFlash{
    0%{ opacity:0; }
    20%{ opacity:1; }
    100%{ opacity:0; }
  }
  .flView{
    width:100%;
    flex:1;
  }
  .flView--active{
    display:flex;
    flex-direction:column;
  }
  .flView[hidden]{ display:none; }
  .flView .shell{ margin:0 auto; }
  .dashboardShell{
    width:100%;
    max-width:1200px;
    margin:0 auto;
    background:linear-gradient(180deg, rgba(255,255,255,.96), rgba(248,250,252,.92));
    border:1px solid rgba(99,102,241,.18);
    border-radius:var(--radius-lg);
    padding:1.75rem 2rem;
    box-shadow:var(--shadow-soft);
    display:flex;
    flex-direction:column;
    gap:1.5rem;
  }
  .dashboardHeader{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:1rem;
    flex-wrap:wrap;
  }
  .dashboardHeader h1{
    font-size:1.3rem;
    margin:0 0 .35rem;
  }
  .dashboardHeader p{
    margin:0;
    color:var(--text-muted);
    font-size:.9rem;
  }
  .moduleGrid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(min(260px,100%),1fr));
    gap:1rem;
  }
  .dashboardKpis{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
    gap:1rem;
  }
  .kpiCard{
    background:linear-gradient(150deg, rgba(255,255,255,.98), rgba(224,231,255,.85));
    border:1px solid rgba(99,102,241,.2);
    border-radius:var(--radius-lg);
    padding:1rem 1.1rem;
    display:flex;
    flex-direction:column;
    gap:.35rem;
    box-shadow:0 12px 26px rgba(67,56,202,.15);
  }
  .kpiLabel{
    font-size:.7rem;
    text-transform:uppercase;
    letter-spacing:.08em;
    color:var(--text-muted);
  }
  .kpiValue{
    font-size:1.6rem;
    font-weight:700;
  }
  .kpiMeta{
    font-size:.75rem;
    color:var(--text-muted);
  }
  .appsHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:.75rem;
    flex-wrap:wrap;
  }
  .appsHeader h2{
    margin:0;
    font-size:1.05rem;
  }
  .appsMeta{
    font-size:.75rem;
    color:var(--text-muted);
  }
  .moduleCard{
    border:1px solid rgba(99,102,241,.2);
    border-radius:var(--radius-lg);
    padding:1rem;
    background:rgba(255,255,255,.94);
    display:flex;
    flex-direction:column;
    gap:.75rem;
    box-shadow:0 12px 26px rgba(15,23,42,.08);
    transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease;
  }
  .moduleCard:hover{
    transform:translateY(-2px);
    border-color:rgba(99,102,241,.4);
    box-shadow:0 18px 36px rgba(99,102,241,.2);
  }
  .moduleCardHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:.75rem;
  }
  .moduleCardTitle{
    font-weight:700;
    font-size:.95rem;
    margin:0;
  }
  .moduleCardTag{
    font-size:.65rem;
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:.05em;
    background:rgba(99,102,241,.15);
    color:#3730a3;
    border-radius:999px;
    padding:.2rem .55rem;
  }
  .moduleCardDesc{
    font-size:.82rem;
    color:var(--text-muted);
    margin:0;
    line-height:1.4;
  }
  .moduleCardActions{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:.75rem;
  }
  .moduleMeta{
    font-family:var(--mono);
    font-size:.72rem;
    color:var(--text-muted);
  }
  .moduleOpenBtn{
    border:1px solid rgba(99,102,241,.45);
    background:rgba(99,102,241,.12);
    color:#4338ca;
    font-weight:700;
    font-size:.8rem;
    padding:.4rem .8rem;
    border-radius:.6rem;
    cursor:pointer;
  }
  .moduleOpenBtn:hover{
    background:rgba(99,102,241,.2);
  }
  .statusBar{
    display:flex;
    align-items:center;
    gap:.4rem;
    flex-wrap:wrap;
    padding:.35rem .65rem;
    border-radius:var(--radius-md);
    border:1px solid var(--panel-strong);
    background:var(--panel);
    box-shadow:0 16px 32px rgba(15,23,42,.08);
    font-size:.64rem;
    color:var(--text-muted);
  }
  .statusBarLabel{
    font-weight:600;
    text-transform:uppercase;
    letter-spacing:.06em;
    font-size:.58rem;
    color:var(--text-muted);
  }
  .statusPill{
    display:inline-flex;
    align-items:center;
    gap:.28rem;
    border-radius:999px;
    padding:.18rem .45rem;
    border:1px solid rgba(99,102,241,.2);
    background:var(--panel-muted);
    color:var(--text);
    font-weight:600;
    font-size:.62rem;
  }
  .statusPillDot{
    width:6px;
    height:6px;
    border-radius:999px;
    background:var(--panel-strong);
  }
  .statusPill--ok{
    border-color:rgba(34,197,94,.45);
    background:rgba(34,197,94,.12);
    color:#065f46;
  }
  .statusPill--ok .statusPillDot{ background:#22c55e; }
  .statusPill--err{
    border-color:rgba(248,113,113,.5);
    background:rgba(248,113,113,.12);
    color:#991b1b;
  }
  .statusPill--err .statusPillDot{ background:#ef4444; }
  .statusPill--warn{
    border-color:rgba(251,191,36,.55);
    background:rgba(251,191,36,.12);
    color:#92400e;
  }
  .statusPill--warn .statusPillDot{ background:#f59e0b; }
  .shell{
    width:100%;
    max-width:none;
    background:var(--panel);
    border:1px solid var(--panel-strong);
    border-radius:var(--radius-lg);
    box-shadow:0 24px 60px rgba(15,23,42,.08);
    display:grid;
    grid-template-columns:1fr 1fr;
    overflow:hidden;
    min-height:calc(100dvh - 160px);
  }
  @media (max-width:1000px){ .shell{ grid-template-columns:1fr; } }

  /* LEFT */
  .leftPane{
    background:var(--panel);
    padding:1.5rem;
    border-right:1px solid var(--panel-strong);
  }
  @media (max-width:1000px){ .leftPane{ border-right:0; border-bottom:1px solid rgba(148,163,184,.15);} }
  .headerRow{ display:flex; align-items:flex-start; justify-content:space-between; gap:.75rem; flex-wrap:wrap; margin-bottom:.75rem; }
  .line1{ font-size:.95rem; font-weight:700; color:var(--text); display:flex; gap:.5rem 1rem; align-items:center; flex-wrap:wrap; }
  .badge{ background:rgba(34,211,238,.12); border:1px solid rgba(34,211,238,.5); color:#0e7490; font-size:1.1rem; border-radius:var(--radius-md); padding:.2rem .45rem; }
  .sessionInfo{ font-size:.8rem; color:var(--text-muted); line-height:1.4; font-family:var(--mono);} 
  .scanBox,.addrBox,.card{ background:var(--panel); border:1px solid var(--panel-strong); border-radius:var(--radius-md); padding:.85rem; }
  .dispatchTopBar{
    display:flex;
    flex-direction:column;
    gap:1rem;
    background:var(--panel);
    border-radius:var(--radius-lg);
    border:1px solid var(--panel-strong);
    padding:1rem 1.25rem;
    box-shadow:var(--shadow-soft);
  }
  .dispatchTopRow{
    display:flex;
    align-items:center;
    gap:1rem;
    flex-wrap:wrap;
  }
  .dispatchHeading{
    font-weight:800;
    font-size:1.05rem;
    letter-spacing:.01em;
  }
  .dispatchScanField{
    display:flex;
    flex-direction:column;
    gap:.35rem;
    min-width:280px;
    flex:1;
  }
  .dispatchScanField label{
    font-size:.72rem;
    text-transform:uppercase;
    letter-spacing:.08em;
    color:var(--text-muted);
  }
  #scanInput{ width:100%; background:#fff; border:1px solid var(--panel-strong); border-radius:var(--radius-md); color:var(--text); font-family:var(--mono); font-size:1rem; outline:none; padding:.55rem .7rem; }
  #scanInput:focus{ border-color:var(--accent); box-shadow:0 0 0 3px rgba(34,211,238,.2); }
  .dispatchTopActions{
    display:flex;
    align-items:center;
    gap:.6rem;
    flex-wrap:wrap;
  }
  .btn--compact{
    font-size:.7rem;
    padding:.35rem .6rem;
  }
  .dispatchExpandToggle{
    border:1px solid rgba(99,102,241,.4);
    background:rgba(99,102,241,.12);
    color:#312e81;
  }
  .dispatchTopDetails{
    display:none;
    border-top:1px solid var(--panel-strong);
    padding-top:1rem;
    gap:1rem;
  }
  #viewScan.dispatchExpanded .dispatchTopDetails{
    display:grid;
  }
  .dispatchDetailGrid{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
    gap:.85rem;
  }
  .dispatchDetailCard{
    background:var(--panel-muted);
    border:1px solid var(--panel-strong);
    border-radius:var(--radius-md);
    padding:.75rem .85rem;
    display:flex;
    flex-direction:column;
    gap:.35rem;
  }
  .dispatchDetailLabel{
    font-size:.7rem;
    text-transform:uppercase;
    letter-spacing:.08em;
    color:var(--text-muted);
    font-weight:700;
  }
  .dispatchDetailValue{
    font-size:.9rem;
    font-weight:700;
  }
  .dispatchDetailAddress{
    grid-column:1/-1;
  }
  .dispatchDetailAddress .dispatchDetailValue{
    font-weight:500;
    white-space:pre-line;
    font-size:.85rem;
  }
  .dispatchTopPanels{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(260px, 1fr));
    gap:.85rem;
  }
  .dispatchTruckIndicator{
    margin-left:auto;
    display:flex;
    align-items:center;
    gap:.75rem;
  }
  .dispatchTruckButton{
    display:flex;
    align-items:center;
    gap:.5rem;
    border:1px solid rgba(239,68,68,.6);
    background:rgba(239,68,68,.08);
    color:#b91c1c;
    border-radius:999px;
    padding:.4rem .75rem;
    font-weight:700;
    font-size:.72rem;
    text-transform:uppercase;
    letter-spacing:.06em;
    cursor:pointer;
  }
  .dispatchTruckButton.is-booked{
    border-color:rgba(34,197,94,.6);
    background:rgba(34,197,94,.12);
    color:#047857;
  }
  .dispatchTruckIcon{
    width:18px;
    height:18px;
    display:inline-flex;
  }
  .dispatchTruckMeta{
    display:flex;
    align-items:center;
    gap:.35rem;
    font-size:.72rem;
    color:var(--text-muted);
  }
  .dispatchTruckBox{
    display:inline-flex;
    align-items:center;
    gap:.35rem;
    font-weight:700;
    color:var(--text);
  }
  .btn{
    border:1px solid rgba(99,102,241,.45);
    background:rgba(99,102,241,.12);
    color:#0f172a;
    font-weight:700;
    font-size:.85rem;
    padding:.55rem .9rem;
    border-radius:.7rem;
    cursor:pointer;
    transition:transform .15s ease, box-shadow .15s ease;
  }
  .btn:hover{ transform:translateY(-1px); box-shadow:0 8px 16px rgba(99,102,241,.2); }
  .btnPrimary{
    background:linear-gradient(120deg, var(--accent), var(--accent-3));
    border-color:transparent;
    color:#fff;
  }
  .btnToggle{
    background:rgba(249,115,22,.12);
    border-color:rgba(249,115,22,.5);
    color:#9a3412;
  }
  .btnToggle.is-active{
    background:#16a34a;
    border-color:#16a34a;
    color:#fff;
    box-shadow:0 8px 18px rgba(22,163,74,.25);
  }

  /* Address picker */
  .addrBox{ margin-bottom:1rem; }
  .addrBox .row{ display:flex; gap:.5rem; align-items:center; margin-bottom:.5rem; }
  .addrBox label{ font-size:.75rem; color:var(--text-muted); display:block; margin-bottom:.35rem; }
  #addrSearch,#placeCode{ flex:1; background:#fff; border:1px solid var(--panel-strong); border-radius:var(--radius-md); color:var(--text); font-family:var(--mono); font-size:.9rem; padding:.4rem .6rem; outline:none; }
  #addrSearch:focus,#placeCode:focus{ border-color:var(--accent); box-shadow:0 0 0 3px rgba(34,211,238,.2); }
  #placeCode{ width:140px; }
  .addrList{ max-height:160px; overflow:auto; border:1px solid var(--panel-strong); border-radius:var(--radius-md); background:var(--panel); }
  .addrItem{ padding:.5rem; border-bottom:1px solid rgba(148,163,184,.3); font-size:.74rem; cursor:pointer; color:var(--text); }
  .addrItem:hover{ background:rgba(34,211,238,.1); }
  .addrHint{ font-size:.7rem; color:var(--text-muted); margin-top:.35rem; }

  /* Small cards */
  .minigrid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(min(260px,100%),1fr)); gap:.75rem; }
  .cardHeader{ font-size:.7rem; color:var(--text-muted); font-weight:700; margin-bottom:.5rem; }
  .cardBody{ font-family:var(--mono); font-size:1.72rem; line-height:1.4; color:var(--text); white-space:pre-wrap; word-break:break-word; }
  #debugLog{ display:none; background:rgba(127,29,29,.2); border:1px solid rgba(248,113,113,.4); color:#fecaca; font-family:var(--mono); font-size:.7rem; line-height:1.4; border-radius:var(--radius-md); padding:.75rem; margin-top:1rem; max-height:180px; overflow:auto; white-space:pre-wrap; }

  /* RIGHT */
  .rightPane{
    padding:1.5rem;
    display:flex;
    flex-direction:column;
    background:var(--panel);
  }
  .sectionTitle{ font-size:.82rem; color:var(--text); font-weight:700; display:flex; justify-content:space-between; gap:.5rem 1rem; margin-bottom:.6rem; }

  .truckPanel{
    background:var(--panel);
    border:1px solid var(--panel-strong);
    border-radius:var(--radius-lg);
    padding:1rem;
    display:flex;
    flex-direction:column;
    gap:.85rem;
    box-shadow:0 12px 28px rgba(15,23,42,.1);
    margin-bottom:1rem;
  }
  .truckHeader{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:1rem;
  }
  .truckTitle{
    font-size:.95rem;
    font-weight:700;
    color:var(--text);
  }
  .truckMeta{
    font-size:.75rem;
    color:var(--text-muted);
    margin-top:.35rem;
  }
  .truckStatus{
    font-size:.7rem;
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:.08em;
    padding:.35rem .6rem;
    border-radius:999px;
    border:1px solid rgba(239,68,68,.5);
    color:#991b1b;
    background:rgba(239,68,68,.12);
  }
  .truckStatus.is-booked{
    border-color:rgba(34,197,94,.5);
    color:#065f46;
    background:rgba(34,197,94,.14);
  }
  .truckBookBtn{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:.75rem;
    font-size:1.2rem;
    font-weight:800;
    letter-spacing:.02em;
    padding:1rem 1.5rem;
    border-radius:1rem;
    border:2px solid rgba(99,102,241,.6);
    background:linear-gradient(135deg, rgba(99,102,241,.95), rgba(34,211,238,.95));
    color:#04121e;
    cursor:pointer;
    box-shadow:0 20px 36px rgba(67,56,202,.28);
    transition:transform .15s ease, box-shadow .15s ease, filter .15s ease;
  }
  .truckBookBtn:hover{
    transform:translateY(-1px) scale(1.01);
    filter:brightness(1.02);
  }
  .truckBookBtn.is-booked{
    border-color:rgba(34,197,94,.7);
    background:linear-gradient(135deg, rgba(34,197,94,.95), rgba(22,163,74,.95));
    box-shadow:0 18px 35px rgba(34,197,94,.28);
  }
  .truckIcon{
    font-size:1.6rem;
  }
  .truckHint{
    font-size:.72rem;
    color:var(--text-muted);
  }
  #modeToggle{
    border:1px solid rgba(99,102,241,.5);
    background:rgba(99,102,241,.12);
    color:#312e81;
    font-weight:700;
    font-size:.75rem;
    padding:.35rem .6rem;
    border-radius:.55rem;
    cursor:pointer;
  }
  .statusChip{ font-size:.62rem; background:var(--panel-muted); border:1px solid var(--panel-strong); border-radius:var(--radius-md); padding:.25rem .4rem; color:var(--text-muted); }
  .summaryCard{ background:var(--panel); border:1px solid var(--panel-strong); border-radius:var(--radius-md); padding:.75rem; margin-bottom:.8rem; font-family:var(--mono); font-size:.7rem; line-height:1.4; color:var(--text); white-space:pre-wrap; word-break:break-word; max-height:240px; overflow:auto; }
  .waybillSheetPreview{ background:#fff; color:#000; border-radius:var(--radius-md); padding:.75rem; font-family:var(--mono); font-size:.72rem; line-height:1.4; min-height:180px; overflow:auto; }

  /* ===== PRINT LOCK (100√ó150mm exact) ===== */
  @media print{
    @page{ size:100mm 150mm; margin:0; }
    html,body{ margin:0!important; padding:0!important; }
    .shell{ display:none!important; }
    .printSheetWrapper{ display:block!important; }
    .wb100x150{
      width:calc(100mm / var(--print-scale))!important;
      height:calc(150mm / var(--print-scale))!important;
      transform:scale(var(--print-scale)); transform-origin:top left;
      page-break-after:always; break-inside:avoid; overflow:hidden; background:#fff;
    }
    img{ print-color-adjust:exact; -webkit-print-color-adjust:exact; }
  }

  .printSheetWrapper{ display:none; padding:0; }
  .wbPreviewZoom{ display:inline-block; transform:scale(.6); transform-origin:top left; }

  /* ===== Waybill rubric (grid canvas) ===== */
  .wb100x150{
    box-sizing:border-box; padding:3mm 3.5mm; color:#000; font-family:var(--mono);
    display:grid; grid-template-rows:18mm auto 52mm; row-gap:2mm;
  }
  .wbHead{ display:grid; grid-template-columns:1fr auto; grid-template-rows:auto auto 1fr; column-gap:3mm; row-gap:1mm; }
  .wbHeadTitle{ grid-column:1/2; grid-row:1; font-size:3.6mm; line-height:1.2; font-weight:700; }
  .wbSvcImg{ grid-column:2/3; grid-row:1/span 3; justify-self:end; align-self:start; display:inline-flex; align-items:center; justify-content:center; padding:.5mm 1mm; overflow:hidden; }
  .wbSvcFallback{ font-weight:700; font-size:3mm; letter-spacing:.2mm; }
 .wbTopCode svg{
  max-width:100%;
  height:auto;
  display:block;
}
.wbTopCode{ grid-column:1/2; grid-row:1; display:flex; flex-direction:column; align-items:left; gap:0mm; }
  .wbTopHuman{ font-size:4.2mm; font-weight:700; }

  .wbBody{ display:grid;  gap:2mm 3mm; margin-top:2mm; }
  .wbFrom,.wbTo{ border:1px solid #000; border-radius:1mm; padding:2mm; font-size:3mm; line-height:1.32; background:#fff; }
  .wbTo{ background:#f7f7f7; }
  .wbBigCode{ grid-column:1/-1; border:1px solid #000; border-radius:1mm; padding:2mm; display:grid; grid-template-rows:auto 1fr auto; row-gap:1mm; }
  .wbBigHuman{ font-size:3.6mm; font-weight:700; text-align:center; }
  .wbBigCode svg{ width:100%; height:15mm; display:block; }
  .wbMetaRow{ display:flex; justify-content:space-between; font-size:3mm; }
  .wbFoot{ border-top:1px dashed #000; padding-top:2mm; display:grid; grid-template-columns:1fr; grid-auto-rows:minmax(0,1fr); row-gap:2mm; }
  .podBox{ border:1px solid #000; border-radius:1mm; padding:2mm; font-size:3.2mm; line-height:1.35; display:grid; grid-template-rows:auto auto auto auto; row-gap:2mm; margin:0 auto; width:300px; }
  .podTitle{  font-size: 12px; font-weight:700; }

/* === DISPATCH BOARD VIEW === */
  #dispatchBoardContainer {
  width:100%;
  display:flex;
  flex-direction:column;
  gap:.85rem;
  padding:1.25rem 0 1.25rem 1.5rem;
  border-radius:var(--radius-lg);
  background:var(--panel);
  border:1px solid var(--panel-strong);
  box-shadow:var(--shadow-soft);
  min-height:calc(100dvh - 160px);
}

.dispatchBoardLayout{
  display:grid;
  grid-template-columns:minmax(0,1fr) 320px;
  gap:1rem;
  align-items:stretch;
  min-height:100%;
}
@media (max-width:1100px){
  .dispatchBoardLayout{
    grid-template-columns:1fr;
  }
}
.dispatchBoardMain{
  display:flex;
  flex-direction:column;
  gap:.85rem;
}
.dispatchBoardSidebar{
  display:flex;
  flex-direction:column;
  gap:.85rem;
  height:100%;
  padding-right:1.5rem;
}
.dispatchShipmentsPanel{
  border-radius:var(--radius-lg);
  border:1px solid var(--panel-strong);
  padding:1rem;
  background:var(--panel);
  box-shadow:0 12px 28px rgba(15,23,42,.08);
  display:flex;
  flex-direction:column;
  flex:1;
}
.dispatchShipmentsHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:.5rem;
  margin-bottom:.75rem;
  font-weight:700;
  font-size:.85rem;
}
.dispatchShipmentsBody{
  display:flex;
  flex-direction:column;
  gap:.6rem;
  flex:1;
}

.dispatchStatusPanel {
  display:flex;
  flex-direction:column;
  gap:.6rem;
  padding:.85rem 1rem;
  border-radius:var(--radius-lg);
  border:1px solid var(--panel-strong);
  background:var(--panel);
  box-shadow:0 18px 36px rgba(15,23,42,.08);
}
.dispatchStatusPanel--compact{
  padding:.65rem .8rem;
  gap:.5rem;
}
.dispatchStatusHeader {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:.75rem;
}
.dispatchStatusHeader h3{
  font-size:.9rem;
  margin:0;
  color:#0f172a;
}
.dispatchStatusLabel{
  font-size:.72rem;
  padding:.25rem .6rem;
  border-radius:999px;
  border:1px solid rgba(249,115,22,.45);
  background:rgba(249,115,22,.15);
  color:#9a3412;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:.05em;
}
.dispatchProgressBar{
  position:relative;
  height:18px;
  border-radius:999px;
  overflow:hidden;
  background:linear-gradient(90deg, rgba(226,232,240,.9), rgba(148,163,184,.25));
  border:1px solid rgba(148,163,184,.5);
}
.dispatchProgressBar.is-pulse{
  animation:dispatchPulse .6s ease;
}
.dispatchProgressFill{
  position:absolute;
  inset:0;
  width:0%;
  background:linear-gradient(90deg, #f97316, #facc15, #22d3ee);
  box-shadow:0 0 14px rgba(251,191,36,.7);
  transition:width .5s ease;
}
.dispatchProgressSun{
  position:absolute;
  top:50%;
  right:12px;
  transform:translateY(-50%);
  width:26px;
  height:26px;
  border-radius:50%;
  background:radial-gradient(circle, rgba(254,240,138,.95), rgba(251,191,36,.95), rgba(249,115,22,.9));
  box-shadow:0 0 20px rgba(251,191,36,.85);
  pointer-events:none;
}
.dispatchProgressSteps{
  display:flex;
  flex-wrap:nowrap;
  justify-content:space-between;
  gap:.4rem;
  font-size:.7rem;
  color:var(--text-muted);
  width:100%;
}
.dispatchStatusPanel--compact .dispatchProgressSteps{
  font-size:.62rem;
}
.dispatchProgressStep{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:.35rem;
  padding:.25rem .2rem;
  border-radius:.5rem;
  border:1px solid var(--panel-strong);
  background:var(--panel-muted);
  flex:1 1 0;
  min-width:0;
  text-align:center;
}
.dispatchProgressDot{
  width:.55rem;
  height:.55rem;
  border-radius:50%;
  background:#cbd5f5;
}
.dispatchProgressStep.is-active{
  border-color:rgba(34,211,238,.8);
  background:rgba(34,211,238,.12);
  color:var(--text);
}
.dispatchProgressStep.is-active .dispatchProgressDot{
  background:#22d3ee;
  box-shadow:0 0 10px rgba(34,211,238,.8);
}
.dispatchProgressStep.is-complete{
  border-color:rgba(34,197,94,.6);
  background:rgba(34,197,94,.12);
  color:#065f46;
}
.dispatchProgressStep.is-complete .dispatchProgressDot{
  background:#22c55e;
  box-shadow:0 0 10px rgba(34,197,94,.65);
}
@keyframes dispatchPulse{
  0%{ transform:scaleX(1); }
  50%{ transform:scaleX(1.02); }
  100%{ transform:scaleX(1); }
}

.dispatchLogPanel{
  border:1px solid var(--panel-strong);
  border-radius:var(--radius-lg);
  background:var(--panel);
  padding:.75rem 1rem;
  box-shadow:0 14px 32px rgba(15,23,42,.08);
}
.dispatchLogPanel--compact{
  padding:.65rem .8rem;
}
.dispatchLogHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  font-size:.8rem;
  font-weight:700;
  color:var(--text);
  margin-bottom:.4rem;
}
.dispatchLog{
  max-height:180px;
  overflow:auto;
  font-size:.72rem;
  color:var(--text);
  line-height:1.4;
}
.dispatchLogPanel--compact .dispatchLog{
  max-height:140px;
}
.dispatchLogEntry{
  padding:.35rem .25rem;
  border-bottom:1px dashed rgba(148,163,184,.25);
  display:flex;
  gap:.5rem;
  align-items:flex-start;
}
.dispatchLogEntry:last-child{
  border-bottom:none;
}
.dispatchLogEntry span{
  font-family:var(--mono);
  color:var(--text-muted);
  min-width:75px;
}

/* lanes across the screen */
#dispatchBoardGrid {
  display: grid;
  grid-template-columns: repeat(5, minmax(0, 1fr));
  gap: 1rem;
  padding: .35rem;
  min-height: 65vh;
  overflow-y: auto;
  background:var(--panel-muted);
}
@media (max-width:1400px){
  #dispatchBoardGrid { grid-template-columns: repeat(3, minmax(0, 1fr)); }
}
@media (max-width:1100px){
  #dispatchBoardGrid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
}
@media (max-width:700px){
  #dispatchBoardGrid { grid-template-columns: 1fr; }
}

/* column headers */
.dispatchColHeader {
  font-size: .9rem;
  font-weight: 700;
  color: #1e3a8a;
  margin-bottom: 0.4rem;
  text-transform: uppercase;
  letter-spacing: 0.6px;
}

/* cards in columns */
.dispatchCard {
  background: var(--panel);
  border: 1px solid var(--panel-strong);
  border-radius: 10px;
  padding: 0.6rem 0.65rem;
  margin-bottom: 0.6rem;
  box-shadow: 0 2px 6px rgba(15,23,42,0.08);
  transition: transform 0.15s ease, box-shadow 0.15s ease;
  cursor: pointer;
}

.dispatchCard:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 14px rgba(34,211,238,0.18);
}

.dispatchCardTitle {
  font-weight: 600;
  font-size: 0.85rem;
  color: var(--text);
  margin-bottom: 0.2rem;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  line-clamp: 2;
  overflow: hidden;
  word-break: break-word;
}

.dispatchCardMeta {
  font-size: 0.68rem;
  color: var(--text-muted);
  margin-bottom: 0.35rem;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}


  .dispatchCardLines {
    font-size: 0.72rem;
    color: #334155;
    line-height: 1.25;
    white-space: pre-line;
    word-break:break-word;
  }
  .dispatchLineItem{
    display:inline;
  }
  .dispatchLineItem.is-complete{
    text-decoration:line-through;
    color:#94a3b8;
  }
  .dispatchLineItem.is-partial{
    text-decoration:line-through;
    color:#94a3b8;
  }
  .dispatchLineRemainder{
    font-weight:800;
    color:#0f172a;
  }

  .dispatchCardActions{
    display:flex;
    justify-content:flex-end;
    flex-wrap:wrap;
    gap:.35rem;
    margin-top:.5rem;
  }

  .dispatchFulfillBtn{
    border:1px solid rgba(34,197,94,.55);
    background:rgba(34,197,94,.16);
    color:#065f46;
    font-size:.7rem;
    font-weight:700;
    padding:.35rem .55rem;
    border-radius:.5rem;
    cursor:pointer;
  }
  .dispatchFulfillBtn:hover{
    background:rgba(34,197,94,.26);
  }
  .dispatchFulfillBtn:disabled{
    opacity:.5;
    cursor:not-allowed;
  }

  .dispatchBookBtn{
    border:1px solid rgba(56,189,248,.45);
    background:rgba(56,189,248,.12);
    color:#0c4a6e;
    font-size:.7rem;
    font-weight:700;
    padding:.35rem .55rem;
    border-radius:.5rem;
    cursor:pointer;
  }

  .dispatchBookBtn:hover{
    background:rgba(56,189,248,.22);
  }
  .dispatchBookBtn:disabled{
    opacity:.5;
    cursor:not-allowed;
  }
  .dispatchNoteBtn{
    border:1px solid rgba(34,197,94,.55);
    background:rgba(34,197,94,.16);
    color:#065f46;
    font-size:.7rem;
    font-weight:700;
    padding:.35rem .55rem;
    border-radius:.5rem;
    cursor:pointer;
  }
  .dispatchNoteBtn:hover{
    background:rgba(34,197,94,.26);
  }
  .dispatchFlowBtn{
    border:1px solid rgba(59,130,246,.45);
    background:rgba(59,130,246,.12);
    color:#1e3a8a;
    font-size:.7rem;
    font-weight:700;
    padding:.35rem .55rem;
    border-radius:.5rem;
    cursor:pointer;
  }
  .dispatchFlowBtn:hover{
    background:rgba(59,130,246,.22);
  }
  .dispatchFlowBtn:disabled{
    opacity:.5;
    cursor:not-allowed;
  }
  .dispatchOppBtn{
    border:1px solid rgba(14,116,144,.45);
    background:rgba(14,116,144,.18);
    color:#0f172a;
    font-size:.7rem;
    font-weight:700;
    padding:.35rem .55rem;
    border-radius:.5rem;
    cursor:pointer;
  }
  .dispatchOppBtn:hover{
    background:rgba(14,116,144,.22);
  }
  .dispatchOppBtn:disabled{
    opacity:.5;
    cursor:not-allowed;
  }
  .dispatchNotifyBtn{
    border:1px solid rgba(234,179,8,.5);
    background:rgba(234,179,8,.18);
    color:#92400e;
    font-size:.7rem;
    font-weight:700;
    padding:.35rem .55rem;
    border-radius:.5rem;
    cursor:pointer;
  }
  .dispatchNotifyBtn:hover{
    background:rgba(234,179,8,.3);
  }
  .dispatchNotifyBtn:disabled{
    opacity:.5;
    cursor:not-allowed;
  }

  .dispatchCol--shipments .dispatchColBody{
    padding:0;
  }

  .dispatchShipmentTable{
    background:#ffffff;
    border:1px solid var(--panel-strong);
    border-radius:10px;
    overflow:hidden;
    box-shadow:0 2px 6px rgba(15,23,42,.08);
  }

  .dispatchShipmentRow{
    display:grid;
    grid-template-columns: 1.2fr 1fr 1fr;
    gap:.5rem;
    padding:.55rem .6rem;
    border-bottom:1px solid var(--panel-strong);
    font-size:.72rem;
    color:var(--text);
    cursor:pointer;
  }

  .dispatchShipmentRow--header{
    background:var(--panel-muted);
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:.6px;
    cursor:default;
  }

  .dispatchShipmentRow:last-child{
    border-bottom:none;
  }

  .dispatchShipmentCell--tracking{
    font-family:var(--mono);
    color:var(--text);
  }

  .dispatchShipmentCell--status{
    color:var(--text-muted);
  }

  .dispatchShipmentEmpty{
    padding:.75rem;
    font-size:.75rem;
    color:var(--text-muted);
  }

  .dispatchShipmentInfo{
    display:grid;
    gap:.35rem;
    font-size:.85rem;
    color:#0f172a;
    margin-bottom:1rem;
  }

  .dispatchShipmentEventsTitle{
    font-weight:700;
    margin-bottom:.5rem;
  }

  .dispatchShipmentEvent{
    border:1px solid #e2e8f0;
    border-radius:.6rem;
    padding:.6rem;
    margin-bottom:.5rem;
    background:#f8fafc;
  }

  .dispatchShipmentEventTitle{
    font-weight:700;
    color:#0f172a;
    margin-bottom:.2rem;
  }

  .dispatchShipmentEventMeta{
    font-size:.72rem;
    color:#64748b;
    margin-bottom:.2rem;
  }

  .dispatchShipmentEventMessage{
    font-size:.78rem;
    color:#334155;
  }

  .dispatchShipmentEventEmpty{
    font-size:.78rem;
    color:#94a3b8;
  }

  .dispatchPackingPanel{
    border-top:1px dashed rgba(148,163,184,.5);
    margin-top:.6rem;
    padding-top:.6rem;
    display:none;
  }
  .dispatchPackingPanel.is-active{
    display:block;
  }
  .dispatchPackingHeader{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:.5rem;
    margin-bottom:.45rem;
  }
  .dispatchPackingTitle{
    font-size:.78rem;
    font-weight:700;
    color:#0f172a;
  }
  .dispatchPackingTimes{
    font-size:.62rem;
    color:#64748b;
    display:flex;
    flex-direction:column;
    gap:.2rem;
    text-align:right;
  }
  .dispatchPackingList{
    display:flex;
    flex-direction:column;
    gap:.45rem;
    margin-bottom:.5rem;
  }
  .dispatchPackingRow{
    border:1px solid rgba(226,232,240,.9);
    border-radius:.5rem;
    padding:.4rem .5rem;
    background:#f8fafc;
  }
  .dispatchPackingRow.is-complete{
    background:rgba(148,163,184,.12);
  }
  .dispatchPackingRow.is-complete .dispatchPackingItem{
    text-decoration:line-through;
    color:#94a3b8;
  }
  .dispatchPackingInfo{
    display:flex;
    flex-direction:column;
    gap:.15rem;
  }
  .dispatchPackingItem{
    font-size:.74rem;
    font-weight:600;
    color:#0f172a;
  }
  .dispatchPackingMeta{
    font-size:.64rem;
    color:#475569;
  }
  .dispatchPackingActions{
    display:flex;
    flex-wrap:wrap;
    gap:.35rem;
    margin-top:.35rem;
  }
  .dispatchPackingQty{
    width:60px;
    border-radius:.4rem;
    border:1px solid rgba(148,163,184,.6);
    padding:.2rem .3rem;
    font-size:.7rem;
  }
  .dispatchPackQtyBtn,
  .dispatchPackAllBtn{
    border-radius:.4rem;
    border:1px solid rgba(59,130,246,.3);
    background:rgba(59,130,246,.08);
    color:#1e3a8a;
    font-size:.66rem;
    padding:.25rem .45rem;
    cursor:pointer;
  }
  .dispatchPackQtyBtn:hover,
  .dispatchPackAllBtn:hover{
    background:rgba(59,130,246,.16);
  }
  .dispatchPackQtyBtn:disabled,
  .dispatchPackAllBtn:disabled{
    opacity:.5;
    cursor:not-allowed;
  }
  .dispatchPackingFooter{
    display:flex;
    flex-direction:column;
    gap:.45rem;
  }
  .dispatchParcelScan{
    display:flex;
    gap:.35rem;
    flex-wrap:wrap;
  }
  .dispatchParcelBoxBtn{
    border-radius:.45rem;
    border:1px solid rgba(124,58,237,.35);
    background:rgba(124,58,237,.12);
    color:#5b21b6;
    font-size:.65rem;
    font-weight:700;
    padding:.3rem .45rem;
    cursor:pointer;
  }
  .dispatchParcelBoxBtn:hover{
    background:rgba(124,58,237,.2);
  }
  .dispatchBoxList{
    display:flex;
    flex-wrap:wrap;
    gap:.35rem;
    font-size:.62rem;
    color:#0f172a;
  }
  .dispatchBoxRow{
    display:flex;
    align-items:center;
    gap:.45rem;
    background:rgba(226,232,240,.8);
    border-radius:.6rem;
    padding:.3rem .5rem;
    font-size:.62rem;
    color:#0f172a;
    font-weight:600;
  }
  .dispatchBoxLabel{
    font-size:.62rem;
    font-weight:700;
    color:#0f172a;
  }
  .dispatchBoxParcelInput{
    border-radius:.4rem;
    border:1px solid rgba(148,163,184,.6);
    padding:.2rem .3rem;
    font-size:.62rem;
    min-width:140px;
  }
  .dispatchBoxEmpty{
    color:#94a3b8;
  }
  .dispatchPackingControls{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:.5rem;
  }
  .dispatchPackingCount{
    font-size:.65rem;
    color:#475569;
  }
  .dispatchFinishPackingBtn{
    border-radius:.45rem;
    border:1px solid rgba(234,88,12,.35);
    background:rgba(251,146,60,.15);
    color:#fdba74;
    font-size:.65rem;
    font-weight:700;
    padding:.3rem .55rem;
    cursor:pointer;
  }
  .dispatchFinishPackingBtn:hover{
    background:rgba(251,146,60,.24);
  }
  .dispatchFinishPackingBtn:disabled{
    opacity:.55;
    cursor:not-allowed;
  }
  .dispatchPackingEmpty{
    font-size:.65rem;
    color:#94a3b8;
  }
  .dispatchOrderModal{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    z-index:60;
  }
  .dispatchOrderModal.is-open{
    display:flex;
  }
  .dispatchOrderModal__backdrop{
    position:absolute;
    inset:0;
    background:rgba(15,23,42,.45);
  }
  .dispatchOrderModal__content{
    position:relative;
    background:var(--panel);
    border-radius:16px;
    border:1px solid var(--panel-strong);
    width:min(900px, 92vw);
    max-height:90vh;
    overflow:hidden;
    box-shadow:0 18px 40px rgba(15,23,42,.2);
    display:flex;
    flex-direction:column;
  }
  .dispatchOrderModal__header{
    padding:1rem 1.2rem 0;
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:1rem;
  }
  .dispatchOrderModal__title{
    font-size:1rem;
    font-weight:700;
    color:var(--text);
  }
  .dispatchOrderModal__meta{
    font-size:.75rem;
    color:#64748b;
    margin-top:.2rem;
  }
  .dispatchOrderModal__body{
    padding:0 1.2rem 1.2rem;
    overflow-y:auto;
  }
  .dispatchOrderModal__close{
    border:none;
    background:rgba(148,163,184,.2);
    color:#0f172a;
    font-weight:700;
    border-radius:999px;
    width:32px;
    height:32px;
    cursor:pointer;
  }
  .dispatchOrderModal__close:hover{
    background:rgba(148,163,184,.35);
  }
  .dispatchShipmentModal{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    z-index:60;
  }
  .dispatchShipmentModal.is-open{
    display:flex;
  }
  .dispatchShipmentModal__backdrop{
    position:absolute;
    inset:0;
    background:rgba(15,23,42,.45);
  }
  .dispatchShipmentModal__content{
    position:relative;
    background:var(--panel);
    border-radius:16px;
    border:1px solid var(--panel-strong);
    width:min(820px, 92vw);
    max-height:90vh;
    overflow:hidden;
    box-shadow:0 18px 40px rgba(15,23,42,.2);
    display:flex;
    flex-direction:column;
  }
  .dispatchShipmentModal__header{
    padding:1rem 1.2rem 0;
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:1rem;
  }
  .dispatchShipmentModal__title{
    font-size:1rem;
    font-weight:700;
    color:var(--text);
  }
  .dispatchShipmentModal__meta{
    font-size:.75rem;
    color:var(--text-muted);
    margin-top:.2rem;
  }
  .dispatchShipmentModal__body{
    padding:0 1.2rem 1.2rem;
    overflow-y:auto;
  }
  .dispatchShipmentModal__close{
    border:none;
    background:rgba(148,163,184,.2);
    color:#0f172a;
    font-weight:700;
    border-radius:999px;
    width:32px;
    height:32px;
    cursor:pointer;
  }
  .dispatchShipmentModal__close:hover{
    background:rgba(148,163,184,.35);
  }

.dispatchColBody {
  overflow-y: auto;
  max-height: 62vh;
  padding-right: 6px;
}

/* lane separation */
.dispatchCol {
  display: flex;
  flex-direction: column;
  background: #f8fafc;
  border-radius: 12px;
  padding: 0.85rem;
  border: 1px solid var(--panel-strong);
}

.dispatchBoardEmpty {
  grid-column: 1 / -1;
  text-align: center;
  font-size: 0.8rem;
  color: var(--text-muted);
  padding: 1rem 0;
}

.dispatchBoardEmptyCol {
  font-size: 0.72rem;
  color: #94a3b8;
  padding: 0.35rem 0.1rem;
}

  .dispatchStamp{
  font-size:.7rem;
  color:var(--text-muted);
  font-family:var(--mono);
}

  /* Documentation */
  .docsShell{
    max-width:1200px;
    width:100%;
    margin:0 auto;
    background:var(--panel);
    border:1px solid var(--panel-strong);
    border-radius:var(--radius-lg);
    box-shadow:0 18px 48px rgba(15,23,42,.1);
    padding:1.75rem 2rem;
  }
  .docsShell h2{
    font-size:1rem;
    margin:1.25rem 0 .5rem;
  }
  .docsShell h3{
    font-size:.9rem;
    margin:1rem 0 .4rem;
  }
  .docsShell h4{
    font-size:.85rem;
    margin:.85rem 0 .35rem;
  }
  .docsShell p,
  .docsShell li{
    font-size:.85rem;
    color:var(--text);
    line-height:1.5;
  }
  .docsShell ul,
  .docsShell ol{
    padding-left:1.1rem;
  }
  .docsGrid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(min(280px,100%),1fr));
    gap:1rem;
  }
  .docsCard{
    border:1px solid var(--panel-strong);
    border-radius:var(--radius-md);
    padding:1rem;
    background:var(--panel);
  }
  .docsMeta{
    font-family:var(--mono);
    font-size:.78rem;
    color:var(--text-muted);
  }
  .docsCode{
    font-family:var(--mono);
    font-size:.78rem;
    background:var(--panel-muted);
    border:1px dashed var(--panel-strong);
    padding:.5rem .6rem;
    border-radius:var(--radius-md);
    color:#0c4a6e;
  }
  .docsBlock{
    font-family:var(--mono);
    font-size:.78rem;
    background:var(--panel-muted);
    border:1px solid var(--panel-strong);
    padding:.85rem 1rem;
    border-radius:var(--radius-md);
    color:var(--text);
    overflow:auto;
    white-space:pre;
  }
  .docsDivider{
    border:none;
    height:1px;
    background:var(--panel-strong);
    margin:1.5rem 0;
  }
  .docsTable{
    width:100%;
    border-collapse:collapse;
    font-size:.82rem;
    color:var(--text);
    margin:0 0 1rem;
  }
  .docsTable th,
  .docsTable td{
    border:1px solid var(--panel-strong);
    padding:.6rem .7rem;
    text-align:left;
    vertical-align:top;
  }
  .docsTable th{
    background:var(--panel-muted);
    font-weight:700;
  }
  .slotEgg{
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:1.5rem;
    z-index:60;
  }
  .slotEgg[hidden]{
    display:none;
  }
  .slotEgg__backdrop{
    position:absolute;
    inset:0;
    background:rgba(15,23,42,.35);
  }
  .slotEgg__panel{
    position:relative;
    background:var(--panel);
    color:var(--text);
    border-radius:1rem;
    padding:1.4rem 1.6rem;
    width:min(420px,92vw);
    box-shadow:0 30px 80px rgba(15,23,42,.2);
    border:1px solid var(--panel-strong);
    z-index:1;
  }
  .slotEgg__header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:.75rem;
    margin-bottom:.4rem;
  }
  .slotEgg__title{
    margin:0;
    font-size:1.15rem;
  }
  .slotEgg__close{
    border:none;
    background:transparent;
    color:var(--text);
    font-size:1.2rem;
    cursor:pointer;
  }
  .slotEgg__hint{
    color:var(--text-muted);
    font-size:.85rem;
    margin:0 0 1rem;
  }
  .slotEgg__reels{
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:.75rem;
    margin-bottom:1rem;
  }
  .slotEgg__reel{
    background:var(--panel-muted);
    border:1px solid var(--panel-strong);
    border-radius:.75rem;
    padding:.9rem .6rem;
    text-align:center;
    font-size:1.1rem;
    font-weight:700;
    letter-spacing:.04em;
    min-height:3.1rem;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .slotEgg__actions{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:.75rem;
    flex-wrap:wrap;
  }
  .slotEgg__spin{
    border:none;
    border-radius:999px;
    padding:.45rem 1.2rem;
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:.08em;
    background:#f97316;
    color:#0f172a;
    cursor:pointer;
  }
  .slotEgg__spin[disabled]{
    opacity:.6;
    cursor:default;
  }
  .slotEgg__result{
    font-size:.85rem;
    color:var(--text-muted);
    flex:1;
    min-width:160px;
  }
  .pill{
    display:inline-flex;
    align-items:center;
    gap:.35rem;
    padding:.2rem .5rem;
    border-radius:999px;
    border:1px solid rgba(34,211,238,.5);
    background:rgba(34,211,238,.12);
    color:#0e7490;
    font-size:.7rem;
    font-weight:600;
  }
  .parcelNumbersPanel{
    background:var(--panel);
    border:1px solid var(--panel-strong);
    border-radius:var(--radius-lg);
    padding:1rem;
    min-height:320px;
    display:flex;
    flex-direction:column;
    gap:.75rem;
  }
  .parcelNumbersHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    font-weight:700;
    color:var(--text);
  }
  .parcelNumbersSub{
    font-size:.78rem;
    color:var(--text-muted);
  }
  .parcelNumbersGrid{
    display:grid;
    grid-template-columns:repeat(auto-fill, minmax(80px, 1fr));
    gap:.75rem;
  }
  .parcelNumber{
    display:grid;
    place-items:center;
    font-size:2.1rem;
    font-weight:800;
    border-radius:1rem;
    min-height:80px;
    background:var(--panel-muted);
    border:2px dashed rgba(148,163,184,.6);
    color:var(--text-muted);
    transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease;
  }
  .parcelNumber.is-scanned{
    border-style:solid;
    border-color:rgba(34,197,94,.6);
    color:#065f46;
    box-shadow:0 10px 25px rgba(34,197,94,.2);
    background:rgba(22,163,74,.14);
    transform:translateY(-2px);
  }
  .parcelNumbersEmpty{
    color:var(--text-muted);
    font-size:.9rem;
    padding:1.5rem 0;
    text-align:center;
  }

</style>
  <link rel="stylesheet" href="/views/flocs.css">
  <link rel="stylesheet" href="/views/stock.css">
  <link rel="stylesheet" href="/views/price-manager.css">
</head>
 <body>
  <div class="flApp">
    <div class="flLayout">
      <aside class="flSide">
        <div class="flSideHeader">
          <div class="flNavTitle">Flippen Lekka Operations</div>
          <button id="navToggle" class="flHamburger" type="button" aria-label="Toggle navigation" aria-expanded="true">
            <span class="flHamburgerLines"><span></span></span>
          </button>
        </div>
        <nav class="flNav" aria-label="Primary">
          <div class="flNavGroup" role="tablist" aria-label="Primary views">
            <button id="navDashboard" class="flNavBtn flNavBtn--active" type="button" role="tab" aria-controls="viewDashboard" aria-selected="true" data-route="/"><span class="flNavBtnIcon" aria-hidden="true">üè†</span><span class="flNavBtnText">Dashboard</span></button>
            <button id="navScan" class="flNavBtn" type="button" role="tab" aria-controls="viewScan" aria-selected="false" data-route="/scan"><span class="flNavBtnIcon" aria-hidden="true">üì¶</span><span class="flNavBtnText">Dispatch</span></button>
            <button id="navOps" class="flNavBtn" type="button" role="tab" aria-controls="viewOps" aria-selected="false" data-route="/ops"><span class="flNavBtnIcon" aria-hidden="true">üöö</span><span class="flNavBtnText">Dispatch Board</span></button>
            <button id="navDocs" class="flNavBtn" type="button" role="tab" aria-controls="viewDocs" aria-selected="false" data-route="/docs"><span class="flNavBtnIcon" aria-hidden="true">üìñ</span><span class="flNavBtnText">Documentation</span></button>
            <button id="navFlocs" class="flNavBtn" type="button" role="tab" aria-controls="viewFlocs" aria-selected="false" data-route="/flocs"><span class="flNavBtnIcon" aria-hidden="true">üìù</span><span class="flNavBtnText">Order capture</span></button>
            <button id="navStock" class="flNavBtn" type="button" role="tab" aria-controls="viewStock" aria-selected="false" data-route="/stock"><span class="flNavBtnIcon" aria-hidden="true">üìä</span><span class="flNavBtnText">Stock take</span></button>
            <button id="navPriceManager" class="flNavBtn" type="button" role="tab" aria-controls="viewPriceManager" aria-selected="false" data-route="/price-manager"><span class="flNavBtnIcon" aria-hidden="true">üí≤</span><span class="flNavBtnText">Price manager</span></button>
          </div>
          <div class="flNavStatus">
            <span id="statusChip" class="statusChip">Ready to scan orders‚Ä¶</span>
          </div>
        </nav>
      </aside>
      <main class="flMain">
        <div id="serverStatusBar" class="statusBar" role="status" aria-live="polite">
          <span class="statusBarLabel">Connections</span>
          <span class="statusPill statusPill--warn"><span class="statusPillDot"></span>Loading‚Ä¶</span>
        </div>

        <div class="flView flView--active" id="viewDashboard">
        <div class="dashboardShell">
          <div class="dashboardHeader">
            <div>
              <h1>Operations Dashboard</h1>
              <p>Quick status glance plus instant access to the core operations apps.</p>
          </div>
        </div>
        <section class="dashboardKpis" aria-label="Key performance indicators">
          <div class="kpiCard">
            <div class="kpiLabel">Today's parcels</div>
            <div class="kpiValue" id="kpiParcels">0</div>
            <div class="kpiMeta">Auto + manual bookings</div>
          </div>
          <div class="kpiCard">
            <div class="kpiLabel">Open dispatch orders</div>
            <div class="kpiValue" id="kpiOpenOrders">0</div>
            <div class="kpiMeta">Shipping, delivery, pickup</div>
          </div>
          <div class="kpiCard">
            <div class="kpiLabel">Recently shipped</div>
            <div class="kpiValue" id="kpiRecentShipments">0</div>
            <div class="kpiMeta">Latest fulfillment events</div>
          </div>
        </section>
        <section>
          <div class="appsHeader">
            <h2>Apps</h2>
          </div>
          <div id="moduleGrid" class="moduleGrid" aria-live="polite"></div>
        </section>
      </div>
    </div>

        <div class="flView" id="viewScan" hidden>
      <div id="screenFlash" class="screenFlash" aria-hidden="true"></div>
      <div class="dispatchTopBar" aria-label="Dispatch controls">
        <div class="dispatchTopRow">
          <div class="dispatchHeading">Dispatch</div>
          <div class="dispatchScanField">
            <label for="scanInput">Scan barcode</label>
            <input id="scanInput" type="text" inputmode="numeric" autocomplete="off" placeholder="Focus here. Scanner types then Enter." autofocus />
          </div>
          <div class="dispatchTopActions">
            <button id="dispatchExpandToggle" class="btn dispatchExpandToggle btn--compact" type="button" aria-expanded="false">Expand</button>
            <button id="multiShipToggle" class="btn btnToggle btn--compact" type="button">Multi-shipment override: Off</button>
            <button id="modeToggle" class="btn btn--compact" type="button">MODE: AUTO</button>
            <button id="btnBookNow" class="btn btnPrimary" hidden>BOOK NOW</button>
          </div>
          <div class="dispatchTruckIndicator">
            <button id="truckBookBtn" class="dispatchTruckButton is-unbooked" type="button" aria-pressed="false">
              <span class="dispatchTruckIcon" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                  <path d="M3 6.75A1.75 1.75 0 0 1 4.75 5h9.5A1.75 1.75 0 0 1 16 6.75V14h1.25c.41 0 .8.18 1.06.49l2.5 3a1.75 1.75 0 0 1 .44 1.13v1.13A1.25 1.25 0 0 1 20 21h-1.1a2.5 2.5 0 0 1-4.9 0H9a2.5 2.5 0 0 1-4.9 0H3.75A.75.75 0 0 1 3 20.25zM16 14V6.75a.25.25 0 0 0-.25-.25h-9.5a.25.25 0 0 0-.25.25V14zm1.8 0h2.25l-2-2.4zm-11.4 6a1 1 0 1 0 0-2 1 1 0 0 0 0 2m10.4-1a1 1 0 1 0-2 0 1 1 0 0 0 2 0"/>
                </svg>
              </span>
              <span id="truckStatus">Not booked</span>
            </button>
            <div class="dispatchTruckMeta">
              <span class="dispatchTruckBox"><span aria-hidden="true">üì¶</span>Truck:<span id="truckParcelCount">0</span></span>
            </div>
          </div>
        </div>
        <div class="dispatchTopDetails">
          <div class="dispatchDetailGrid">
            <div class="dispatchDetailCard">
              <span class="dispatchDetailLabel">Customer</span>
              <span id="uiCustomerName" class="dispatchDetailValue">--</span>
            </div>
            <div class="dispatchDetailCard">
              <span class="dispatchDetailLabel">Order</span>
              <span id="uiOrderNo" class="dispatchDetailValue">--</span>
            </div>
            <div class="dispatchDetailCard">
              <span class="dispatchDetailLabel">Order weight</span>
              <span id="uiOrderWeight" class="dispatchDetailValue">--</span>
            </div>
            <div class="dispatchDetailCard dispatchDetailAddress">
              <span class="dispatchDetailLabel">Shipping address</span>
              <span id="shipToCard" class="dispatchDetailValue">None yet.</span>
            </div>
          </div>
          <div class="dispatchTopPanels">
            <div class="dispatchStatusPanel dispatchStatusPanel--compact" aria-live="polite">
              <div class="dispatchStatusHeader">
                <h3>Booking progress</h3>
                <span id="scanProgressLabel" class="dispatchStatusLabel">Idle</span>
              </div>
              <div class="dispatchProgressBar" id="scanProgressBar">
                <div id="scanProgressFill" class="dispatchProgressFill"></div>
                <div class="dispatchProgressSun" aria-hidden="true"></div>
              </div>
              <div class="dispatchProgressSteps" id="scanProgressSteps"></div>
            </div>
            <div class="dispatchLogPanel dispatchLogPanel--compact">
              <div class="dispatchLogHeader">
                <span>Dispatch log</span>
                <span class="dispatchStamp">Latest activity</span>
              </div>
              <div id="scanDispatchLog" class="dispatchLog" aria-live="polite"></div>
            </div>
          </div>
        </div>
      </div>
      <div id="dispatchBoardContainer" role="application" aria-label="Flippen Lekka Dispatch">
        <div class="dispatchBoardLayout">
          <div class="dispatchBoardMain">
            <div class="dispatchStatusPanel" aria-live="polite">
              <div class="dispatchStatusHeader">
                <h3>Booking progress</h3>
                <span id="dispatchProgressLabel" class="dispatchStatusLabel">Idle</span>
              </div>
              <div class="dispatchProgressBar" id="dispatchProgressBar">
                <div id="dispatchProgressFill" class="dispatchProgressFill"></div>
                <div class="dispatchProgressSun" aria-hidden="true"></div>
              </div>
              <div class="dispatchProgressSteps" id="dispatchProgressSteps"></div>
            </div>
            <div class="dispatchLogPanel">
              <div class="dispatchLogHeader">
                <span>Dispatch log</span>
                <span class="dispatchStamp">Latest activity</span>
              </div>
              <div id="dispatchLog" class="dispatchLog" aria-live="polite"></div>
            </div>
            <div class="dispatchBoardPanel">
              <div class="sectionTitle" style="margin-top:.4rem">
                <span>Dispatch Whiteboard</span>
                <span id="dispatchStamp" class="dispatchStamp">‚Äì</span>
              </div>
              <div class="dispatchBoard" id="dispatchBoardGrid">
                <div class="dispatchBoardEmpty">Loading open orders‚Ä¶</div>
              </div>
            </div>
          </div>
          <aside class="dispatchBoardSidebar" aria-label="Dispatch sidebar">
            <div class="dispatchShipmentsPanel">
              <div class="dispatchShipmentsHeader">
                <span>Recently shipped</span>
                <span class="dispatchStamp">Latest activity</span>
              </div>
              <div id="dispatchShipmentsSidebar" class="dispatchShipmentsBody">
                <div class="dispatchShipmentEmpty">Loading recent shipments‚Ä¶</div>
              </div>
            </div>
          </aside>
        </div>
      </div>
    </div>

    <div class="flView" id="viewOps" hidden></div>
      <div class="dispatchOrderModal" id="dispatchOrderModal" aria-hidden="true">
        <div class="dispatchOrderModal__backdrop" data-action="close-modal" aria-hidden="true"></div>
        <div class="dispatchOrderModal__content" role="dialog" aria-modal="true" aria-labelledby="dispatchOrderModalTitle">
          <div class="dispatchOrderModal__header">
            <div>
              <div class="dispatchOrderModal__title" id="dispatchOrderModalTitle">Order</div>
              <div class="dispatchOrderModal__meta" id="dispatchOrderModalMeta"></div>
            </div>
            <button class="dispatchOrderModal__close" type="button" data-action="close-modal" aria-label="Close order details">‚úï</button>
          </div>
          <div class="dispatchOrderModal__body" id="dispatchOrderModalBody"></div>
        </div>
      </div>
      <div class="dispatchShipmentModal" id="dispatchShipmentModal" aria-hidden="true">
        <div class="dispatchShipmentModal__backdrop" data-action="close-modal" aria-hidden="true"></div>
        <div class="dispatchShipmentModal__content" role="dialog" aria-modal="true" aria-labelledby="dispatchShipmentModalTitle">
          <div class="dispatchShipmentModal__header">
            <div>
              <div class="dispatchShipmentModal__title" id="dispatchShipmentModalTitle">Shipment</div>
              <div class="dispatchShipmentModal__meta" id="dispatchShipmentModalMeta"></div>
            </div>
            <button class="dispatchShipmentModal__close" type="button" data-action="close-modal" aria-label="Close shipment details">‚úï</button>
          </div>
          <div class="dispatchShipmentModal__body" id="dispatchShipmentModalBody"></div>
        </div>
      </div>
    </div>

        <div class="flView" id="viewDocs" hidden>
      <div class="docsShell">
        <div class="pill">README</div>
        <h2>Flippen Lekka Scan Station (FLSS)</h2>

        <h3>Scope and purpose</h3>
        <p>FLSS is a single-page operations console for Flippen Lekka that combines three operator workflows behind one Node/Express backend:</p>
        <ul>
          <li><strong>Scan Station</strong> for booking ParcelPerfect shipments based on scanned parcel barcodes and Shopify order data.</li>
          <li><strong>Dispatch Board</strong> for triaging open Shopify orders into delivery/shipping/pickup lanes.</li>
          <li><strong>FLOCS (Order Capture)</strong> for creating Shopify customers, searching products, quoting shipping, and creating draft orders/orders.</li>
          <li><strong>Stock Take</strong> for offline/local stock adjustments stored in browser storage.</li>
        </ul>
        <p>The server acts as a secure proxy to ParcelPerfect, Shopify Admin APIs (OAuth client credentials), and PrintNode. It also serves the static frontend pages from <span class="docsCode">/public</span>.„ÄêF:server.js‚Ä†L1-L453„Äë„ÄêF:public/index.html‚Ä†L1-L530„Äë„ÄêF:public/app.js‚Ä†L1-L1716„Äë„ÄêF:public/flocs.html‚Ä†L1-L200„Äë„ÄêF:public/flocs.js‚Ä†L1-L200„Äë„ÄêF:public/stock.js‚Ä†L1-L200„Äë</p>

        <hr class="docsDivider" />

        <h3>High-level architecture</h3>
        <pre class="docsBlock"><code>flowchart LR
  subgraph Browser
    Scan[Scan Station UI]
    Dispatch[Dispatch Board]
    FLOCS[FLOCS Order Capture]
    Stock[Stock Take]
  end

  subgraph Server[Express backend]
    API[API routes]
    Static[Static file server]
    TokenCache[Shopify token cache]
  end

  subgraph External
    Shopify[(Shopify Admin API)]
    ParcelPerfect[(ParcelPerfect API)]
    PrintNode[(PrintNode API)]
  end

  Scan --&gt;|/shopify/orders/by-name| API
  Scan --&gt;|/pp place + booking| API
  Scan --&gt;|/printnode/print| API

  Dispatch --&gt;|/shopify/orders/open| API
  Dispatch --&gt;|Book Now -&gt; /pp + /shopify/fulfill| API

  FLOCS --&gt;|/shopify/customers/search| API
  FLOCS --&gt;|/shopify/customers| API
  FLOCS --&gt;|/shopify/products/search| API
  FLOCS --&gt;|/shopify/products/collection| API
  FLOCS --&gt;|/shopify/draft-orders| API
  FLOCS --&gt;|/shopify/draft-orders/complete| API
  FLOCS --&gt;|/shopify/orders| API
  FLOCS --&gt;|/pp quote + booking| API

  API --&gt; TokenCache --&gt; Shopify
  API --&gt; ParcelPerfect
  API --&gt; PrintNode
  Static --&gt; Scan
  Static --&gt; Dispatch
  Static --&gt; FLOCS
  Static --&gt; Stock</code></pre>
        <p>The browser pages call the server through same-origin endpoints, which then proxy to external services (with rate limiting, CORS, and token caching). The frontend never talks directly to Shopify/ParcelPerfect/PrintNode‚Äîonly to the server. The server also handles static files, SPA fallback, and a health check.„ÄêF:server.js‚Ä†L1-L453„Äë„ÄêF:public/index.html‚Ä†L1-L530„Äë</p>

        <hr class="docsDivider" />

        <h3>Backend responsibilities (Express)</h3>
        <h4>Core infrastructure</h4>
        <ul>
          <li><strong>Config + env</strong>: server config is read from environment variables (host/port, ParcelPerfect, Shopify, PrintNode, CORS origins).„ÄêF:server.js‚Ä†L18-L60„Äë</li>
          <li><strong>Middleware</strong>: CORS allowlist, rate limiting (120 requests/min), Helmet, JSON parsing, logging, and OPTIONS handling.„ÄêF:server.js‚Ä†L62-L113„Äë</li>
          <li><strong>Static hosting</strong>: serves <span class="docsCode">/public</span> files and routes <span class="docsCode">/flocs</span> to the order capture UI, with SPA fallback to <span class="docsCode">index.html</span>.„ÄêF:server.js‚Ä†L434-L446„Äë</li>
        </ul>
        <h4>Shopify API proxy (client credentials)</h4>
        <ul>
          <li>Shopify uses <strong>OAuth client_credentials</strong> flow via the Dev Dashboard app. The server requests a token and caches it (with expiry buffer). Calls are retried if the token is invalidated.„ÄêF:server.js‚Ä†L120-L207„Äë</li>
        </ul>
        <h4>ParcelPerfect proxy</h4>
        <ul>
          <li><span class="docsCode">/pp</span> accepts a method/class/params payload, then submits a form-encoded request to ParcelPerfect and returns JSON or text.„ÄêF:server.js‚Ä†L209-L271„Äë</li>
          <li><span class="docsCode">/pp/place</span> does place lookups by name or postcode (requires PP token).„ÄêF:server.js‚Ä†L388-L433„Äë</li>
        </ul>
        <h4>PrintNode proxy</h4>
        <ul>
          <li><span class="docsCode">/printnode/print</span> accepts base64 PDF content and sends a print job to PrintNode for label printing.„ÄêF:server.js‚Ä†L435-L503„Äë</li>
        </ul>
        <h4>Shopify domain endpoints</h4>
        <ul>
          <li>Customers: search and create customers with optional delivery method metafield.„ÄêF:server.js‚Ä†L273-L374„Äë</li>
          <li>Products: search by title/SKU and load collection items.„ÄêF:server.js‚Ä†L376-L564„Äë</li>
          <li>Draft orders: create and complete draft orders (with tags, shipping lines, and note attributes).„ÄêF:server.js‚Ä†L566-L699„Äë</li>
          <li>Orders: create orders, find by name, list open orders, and fulfill orders with tracking data.„ÄêF:server.js‚Ä†L701-L873„Äë</li>
        </ul>

        <hr class="docsDivider" />

        <h3>Frontend modules</h3>
        <h4>1) Scan Station (index + app.js)</h4>
        <p>Primary operator workflow for scanning parcel barcodes and booking shipments.</p>
        <p><strong>Key responsibilities</strong></p>
        <ul>
          <li>Parse scanned barcodes into <span class="docsCode">{orderNo, parcelSeq}</span> (last 3 digits are parcel sequence).„ÄêF:public/app.js‚Ä†L1160-L1197„Äë</li>
          <li>Fetch Shopify order details via <span class="docsCode">/shopify/orders/by-name/:name</span>.„ÄêF:public/app.js‚Ä†L1224-L1318„Äë</li>
          <li>Determine expected parcel count from Shopify tags (<span class="docsCode">parcel_count_#</span>) or manual/scan count. If tagged, booking triggers on the first scan; otherwise a 6s idle timer triggers booking automatically in auto mode.„ÄêF:public/app.js‚Ä†L300-L470„Äë„ÄêF:public/app.js‚Ä†L1199-L1286„Äë</li>
          <li>Generate waybill previews and optionally print via PrintNode / ParcelPerfect responses (PDF base64).„ÄêF:public/app.js‚Ä†L1460-L1716„Äë</li>
          <li>Fulfill the order in Shopify after booking, and store booked orders in <span class="docsCode">localStorage</span> to prevent duplicate bookings in the session/device.„ÄêF:public/app.js‚Ä†L430-L556„Äë„ÄêF:public/app.js‚Ä†L1578-L1716„Äë</li>
        </ul>
        <h4>2) Dispatch Board (index + app.js)</h4>
        <p>Ops dashboard that lists open Shopify orders in lanes (delivery/shipping/pickup), with a ‚ÄúBook Now‚Äù action or delivery note printing.</p>
        <ul>
          <li>Pulls open orders from <span class="docsCode">/shopify/orders/open</span> every 30 seconds and filters by age/status.„ÄêF:public/app.js‚Ä†L1341-L1460„Äë„ÄêF:public/app.js‚Ä†L1605-L1716„Äë</li>
          <li>Assigns orders to lanes based on tags and shipping line titles (<span class="docsCode">warehouse/collect</span> ‚Üí pickup, <span class="docsCode">local delivery/same day</span> ‚Üí delivery, else shipping).„ÄêF:public/app.js‚Ä†L1375-L1418„Äë</li>
          <li>‚ÄúBook Now‚Äù prompts for parcel count, loads the order, and triggers booking flow using Scan Station logic.„ÄêF:public/app.js‚Ä†L1648-L1702„Äë</li>
          <li>‚ÄúPrint delivery note‚Äù opens a printable HTML document with line items and shipping address details.„ÄêF:public/app.js‚Ä†L1462-L1533„Äë</li>
        </ul>
        <h4>3) FLOCS (Order Capture)</h4>
        <p>A standalone page (<span class="docsCode">/flocs</span>) to capture a new order:</p>
        <ul>
          <li>Search/select Shopify customers, create new customers, and store a preferred delivery method as a metafield (<span class="docsCode">custom.delivery_method</span>).„ÄêF:public/flocs.js‚Ä†L1-L260„Äë„ÄêF:server.js‚Ä†L273-L374„Äë</li>
          <li>Search products by title/SKU, load collection items, or use a local SKU/variant catalog (<span class="docsCode">CONFIG.PRODUCTS</span>).„ÄêF:public/flocs.js‚Ä†L1-L200„Äë„ÄêF:server.js‚Ä†L376-L564„Äë</li>
          <li>Calculate shipping quotes via ParcelPerfect (<span class="docsCode">/pp</span>) and embed shipping cost/services into draft orders or orders.„ÄêF:public/flocs.js‚Ä†L1-L200„Äë</li>
          <li>Create draft orders, complete them to orders, or create orders directly via Shopify endpoints.„ÄêF:public/flocs.js‚Ä†L1-L200„Äë„ÄêF:server.js‚Ä†L566-L799„Äë</li>
        </ul>
        <h4>4) Stock Take</h4>
        <ul>
          <li>Local-only stock counts stored in <span class="docsCode">localStorage</span> under <span class="docsCode">fl_stock_levels_v1</span> with ‚Äústock take‚Äù and ‚Äústock received‚Äù modes; no backend calls required.„ÄêF:public/stock.js‚Ä†L1-L200„Äë</li>
        </ul>
        <h4>5) Price Manager</h4>
        <ul>
          <li>Dedicated price-tier editor (<span class="docsCode">/price-manager.html</span>) to review SKU pricing tiers and sync tiers into Shopify variant metafields (<span class="docsCode">custom.price_tiers</span>).</li>
          <li>Supports optional public price sync to update storefront pricing by writing the variant price through the Admin API.„ÄêF:public/price-manager.js‚Ä†L1-L201„Äë„ÄêF:server.js‚Ä†L289-L366„Äë</li>
          <li>Theme-only pricing logic (no extra app) can be implemented by reading <span class="docsCode">custom.price_tiers</span> in your Shopify theme and resolving prices from customer tags. See <span class="docsCode">docs/price-tiers-theme.md</span>.</li>
        </ul>

        <hr class="docsDivider" />

        <h3>Data model</h3>
        <h4>Primary entities (frontend)</h4>
        <table class="docsTable">
          <thead>
            <tr>
              <th>Entity</th>
              <th>Description</th>
              <th>Source</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><span class="docsCode">orderDetails</span></td>
              <td>Normalized Shopify order data used for bookings: name, contact details, address, line items, weights, parcel counts, and place code.</td>
              <td><span class="docsCode">/shopify/orders/by-name/:name</span> + ParcelPerfect place lookup.„ÄêF:public/app.js‚Ä†L1224-L1318„Äë</td>
            </tr>
            <tr>
              <td><span class="docsCode">parcel</span></td>
              <td>Parsed scan information: <span class="docsCode">{ orderNo, parcelSeq }</span>.</td>
              <td>Scan input parsing logic.„ÄêF:public/app.js‚Ä†L1160-L1197„Äë</td>
            </tr>
            <tr>
              <td><span class="docsCode">dispatchOrder</span></td>
              <td>Open order card data: customer name, shipping address, line items, status.</td>
              <td><span class="docsCode">/shopify/orders/open</span> response transformed by backend.„ÄêF:server.js‚Ä†L756-L873„Äë„ÄêF:public/app.js‚Ä†L1341-L1460„Äë</td>
            </tr>
            <tr>
              <td>flocs state</td>
              <td>Current order capture state including customer, address, items, shipping quote, and price tier.</td>
              <td><span class="docsCode">state</span> object in FLOCS JS.„ÄêF:public/flocs.js‚Ä†L116-L180„Äë</td>
            </tr>
            <tr>
              <td><span class="docsCode">stockLevels</span></td>
              <td>Local map of SKU ‚Üí count.</td>
              <td><span class="docsCode">localStorage</span> in stock tool.„ÄêF:public/stock.js‚Ä†L34-L112„Äë</td>
            </tr>
          </tbody>
        </table>
        <h4>Shopify entities (backend normalization)</h4>
        <table class="docsTable">
          <thead>
            <tr>
              <th>Entity</th>
              <th>Key fields (used in app)</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Customer</td>
              <td><span class="docsCode">id</span>, <span class="docsCode">name</span>, <span class="docsCode">email</span>, <span class="docsCode">phone</span>, <span class="docsCode">addresses</span>, <span class="docsCode">default_address</span>, <span class="docsCode">tags</span>, <span class="docsCode">delivery_method</span> metafield</td>
              <td>Normalized in <span class="docsCode">normalizeCustomer</span>.„ÄêF:server.js‚Ä†L82-L128„Äë„ÄêF:server.js‚Ä†L273-L337„Äë</td>
            </tr>
            <tr>
              <td>Order</td>
              <td><span class="docsCode">id</span>, <span class="docsCode">name</span>, <span class="docsCode">shipping_address</span>, <span class="docsCode">line_items</span>, <span class="docsCode">tags</span>, <span class="docsCode">fulfillment_status</span></td>
              <td>Used for booking and dispatch board output.„ÄêF:server.js‚Ä†L701-L873„Äë</td>
            </tr>
            <tr>
              <td>DraftOrder</td>
              <td><span class="docsCode">id</span>, <span class="docsCode">name</span>, <span class="docsCode">invoice_url</span>, <span class="docsCode">tags</span>, <span class="docsCode">shipping_line</span></td>
              <td>Created from FLOCS for invoicing workflow.„ÄêF:server.js‚Ä†L566-L699„Äë</td>
            </tr>
          </tbody>
        </table>
        <h4>ParcelPerfect entities</h4>
        <table class="docsTable">
          <thead>
            <tr>
              <th>Entity</th>
              <th>Fields</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Booking request</td>
              <td><span class="docsCode">{ method, class, params }</span></td>
              <td>Sent as form data to <span class="docsCode">/pp</span> with optional <span class="docsCode">token_id</span>.„ÄêF:server.js‚Ä†L209-L271„Äë</td>
            </tr>
            <tr>
              <td>Place lookup</td>
              <td><span class="docsCode">getPlacesByName</span> / <span class="docsCode">getPlacesByPostcode</span></td>
              <td>Used when Shopify has no stored place code. „ÄêF:server.js‚Ä†L388-L433„Äë„ÄêF:public/app.js‚Ä†L1224-L1318„Äë</td>
            </tr>
          </tbody>
        </table>
        <h4>PrintNode entities</h4>
        <table class="docsTable">
          <thead>
            <tr>
              <th>Entity</th>
              <th>Fields</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Print job</td>
              <td><span class="docsCode">printerId</span>, <span class="docsCode">title</span>, <span class="docsCode">contentType</span>, <span class="docsCode">content</span></td>
              <td>Prints ParcelPerfect PDF labels. „ÄêF:server.js‚Ä†L435-L503„Äë</td>
            </tr>
          </tbody>
        </table>

        <hr class="docsDivider" />

        <h3>Automatic actions &amp; background behavior</h3>
        <h4>Backend</h4>
        <ul>
          <li><strong>Token caching</strong>: Shopify access tokens are cached and refreshed before expiry, with a retry on 401/403 responses.„ÄêF:server.js‚Ä†L120-L207„Äë</li>
          <li><strong>Rate limiting</strong>: 120 requests/minute (standard headers enabled).„ÄêF:server.js‚Ä†L92-L107„Äë</li>
          <li><strong>CORS enforcement</strong>: if <span class="docsCode">FRONTEND_ORIGIN</span> is set, only origins listed there are allowed (unless <span class="docsCode">*</span>). When it is unset, all origins are allowed by default.„ÄêF:server.js‚Ä†L62-L91„Äë</li>
        </ul>
        <h4>Scan Station (frontend)</h4>
        <ul>
          <li><strong>Auto-booking by tag</strong>: orders tagged <span class="docsCode">parcel_count_#</span> auto-book on first scan (no timer).„ÄêF:public/app.js‚Ä†L1184-L1244„Äë</li>
          <li><strong>Idle auto-book</strong>: if no tag exists, a 6 second idle timer triggers booking based on scanned parcel count in auto mode.„ÄêF:public/app.js‚Ä†L300-L370„Äë</li>
          <li><strong>Local booking guard</strong>: booked order numbers are stored in <span class="docsCode">localStorage</span> and blocked from re-booking in the same browser session/device.„ÄêF:public/app.js‚Ä†L430-L556„Äë„ÄêF:public/app.js‚Ä†L1170-L1208„Äë</li>
          <li><strong>Mode preference</strong>: auto/manual mode is persisted in <span class="docsCode">localStorage</span> (<span class="docsCode">fl_mode_v1</span>).„ÄêF:public/app.js‚Ä†L400-L426„Äë</li>
        </ul>
        <h4>Dispatch Board</h4>
        <ul>
          <li><strong>Auto refresh</strong> every 30 seconds to keep the board current with Shopify open orders.„ÄêF:public/app.js‚Ä†L1535-L1716„Äë</li>
          <li><strong>Audio cues + progress bar</strong> for booking steps; visual/log updates are emitted during booking and print steps.„ÄêF:public/app.js‚Ä†L170-L300„Äë„ÄêF:public/app.js‚Ä†L1535-L1702„Äë</li>
        </ul>
        <h4>FLOCS (Order Capture)</h4>
        <ul>
          <li><strong>Customer/product search debounce</strong> and local SKU catalog enable faster entry even if Shopify search is slow or limited.„ÄêF:public/flocs.js‚Ä†L1-L200„Äë</li>
          <li><strong>Price tiers</strong> are derived from Shopify customer tags to automatically apply price lists (agent/retailer/export/private/fkb).„ÄêF:public/flocs.js‚Ä†L146-L200„Äë</li>
        </ul>
        <h4>Stock Take</h4>
        <ul>
          <li><strong>Local persistence</strong>: stock levels are stored and restored from <span class="docsCode">localStorage</span>, keeping the tool offline-friendly.„ÄêF:public/stock.js‚Ä†L34-L112„Äë</li>
        </ul>

        <hr class="docsDivider" />

        <h3>API reference (server)</h3>
        <p><em>All endpoints are served from the same origin as the frontend (default <span class="docsCode">http://localhost:3000</span>).</em></p>
        <h4>ParcelPerfect</h4>
        <ul>
          <li><span class="docsCode">POST /pp</span> ‚Äî ParcelPerfect proxy for booking/quote calls. Expects <span class="docsCode">{ method, class, params }</span> JSON body. „ÄêF:server.js‚Ä†L209-L271„Äë</li>
          <li><span class="docsCode">GET /pp/place?q=...</span> ‚Äî ParcelPerfect place lookup by name or postcode. „ÄêF:server.js‚Ä†L388-L433„Äë</li>
        </ul>
        <h4>Shopify</h4>
        <ul>
          <li><span class="docsCode">GET /shopify/customers/search?q=...</span> ‚Äî Search customers. „ÄêF:server.js‚Ä†L273-L337„Äë</li>
          <li><span class="docsCode">POST /shopify/customers</span> ‚Äî Create customer with optional delivery method metafield. „ÄêF:server.js‚Ä†L339-L374„Äë</li>
          <li><span class="docsCode">GET /shopify/products/search?q=...</span> ‚Äî Product + variant search. „ÄêF:server.js‚Ä†L376-L470„Äë</li>
          <li><span class="docsCode">GET /shopify/products/collection?handle=...</span> ‚Äî Products in a collection. „ÄêF:server.js‚Ä†L472-L564„Äë</li>
          <li><span class="docsCode">POST /shopify/draft-orders</span> ‚Äî Create draft order. „ÄêF:server.js‚Ä†L566-L669„Äë</li>
          <li><span class="docsCode">POST /shopify/draft-orders/complete</span> ‚Äî Complete draft order. „ÄêF:server.js‚Ä†L671-L721„Äë</li>
          <li><span class="docsCode">POST /shopify/orders</span> ‚Äî Create order. „ÄêF:server.js‚Ä†L723-L799„Äë</li>
          <li><span class="docsCode">GET /shopify/orders/by-name/:name</span> ‚Äî Find order by Shopify name. „ÄêF:server.js‚Ä†L801-L873„Äë</li>
          <li><span class="docsCode">GET /shopify/orders/open</span> ‚Äî Open orders for dispatch board. „ÄêF:server.js‚Ä†L875-L956„Äë</li>
          <li><span class="docsCode">POST /shopify/fulfill</span> ‚Äî Fulfill order with tracking. „ÄêF:server.js‚Ä†L958-L1057„Äë</li>
        </ul>
        <h4>PrintNode</h4>
        <ul>
          <li><span class="docsCode">POST /printnode/print</span> ‚Äî Print a base64 PDF to a configured printer. „ÄêF:server.js‚Ä†L435-L503„Äë</li>
        </ul>
        <h4>Utility</h4>
        <ul>
          <li><span class="docsCode">GET /healthz</span> ‚Äî Health check. „ÄêF:server.js‚Ä†L505-L507„Äë</li>
        </ul>

        <hr class="docsDivider" />

        <h3>Configuration</h3>
        <p>Configuration comes from environment variables. The server expects these at runtime (example values shown):</p>
        <pre class="docsBlock"><code>PORT=3000
HOST=0.0.0.0
# Optional: comma-separated origins, or "*" to allow all origins
# FRONTEND_ORIGIN=http://localhost:3000,http://192.168.1.25:3000

# ParcelPerfect
PP_BASE_URL=https://adpdemo.pperfect.com/ecomService/v10/Json/
PP_REQUIRE_TOKEN=true
PP_TOKEN=your-parcelperfect-token
PP_ACCNUM=account-number
PP_PLACE_ID=origin-place-id

# Shopify Dev Dashboard OAuth
SHOPIFY_STORE=your-store-subdomain
SHOPIFY_CLIENT_ID=your-client-id
SHOPIFY_CLIENT_SECRET=your-client-secret
SHOPIFY_API_VERSION=2025-10

# PrintNode
PRINTNODE_API_KEY=your-printnode-api-key
PRINTNODE_PRINTER_ID=123456</code></pre>
        <p>The included <span class="docsCode">.env.example</span> file is a starting point, but Shopify configuration has been updated to use OAuth client credentials in the server (see <span class="docsCode">SHOPIFY_CLIENT_ID</span> and <span class="docsCode">SHOPIFY_CLIENT_SECRET</span>).„ÄêF:server.js‚Ä†L18-L60„Äë„ÄêF:.env.example‚Ä†L1-L18„Äë</p>

        <hr class="docsDivider" />

        <h3>User flows</h3>
        <h4>Scan Station booking flow</h4>
        <ol>
          <li>Operator scans a parcel barcode ‚Üí parse <span class="docsCode">orderNo</span> + <span class="docsCode">parcelSeq</span>.</li>
          <li>App fetches Shopify order data and customer place code (metafield or ParcelPerfect lookup).</li>
          <li>If order has <span class="docsCode">parcel_count_#</span> tag, booking happens immediately; otherwise scans accumulate and idle timer triggers booking.</li>
          <li>Booking request goes to ParcelPerfect via <span class="docsCode">/pp</span> with service + parcel details; a label PDF may be returned.</li>
          <li>Booking result triggers Shopify fulfillment with tracking number and optional label printing via PrintNode.</li>
        </ol>
        <p>All steps are logged to the UI, and the order number is added to local blocked list to prevent duplicate booking in the same device session.„ÄêF:public/app.js‚Ä†L1160-L1716„Äë„ÄêF:server.js‚Ä†L209-L503„Äë„ÄêF:server.js‚Ä†L958-L1057„Äë</p>
        <h4>Dispatch Board flow</h4>
        <ol>
          <li>Frontend fetches open orders every 30s and groups into lanes.</li>
          <li>Clicking <strong>Book Now</strong> prompts for parcel count, loads the order, and runs the booking flow.</li>
          <li>Clicking <strong>Print delivery note</strong> opens a printable document for delivery orders.</li>
        </ol>
        <p>This allows warehouse/ops to book shipments from a dispatch overview without switching to the scan view.„ÄêF:public/app.js‚Ä†L1341-L1716„Äë</p>
        <h4>FLOCS flow</h4>
        <ol>
          <li>Search or create a customer.</li>
          <li>Pick delivery method (ship/pickup/deliver), select address, and select products.</li>
          <li>Optionally quote shipping (ParcelPerfect) to fill the shipping line.</li>
          <li>Create draft orders or orders in Shopify, optionally completing drafts.</li>
        </ol>
        <p>FLOCS embeds pricing logic (customer tag-based tiers) and supports collection-based product loading to speed order creation.„ÄêF:public/flocs.js‚Ä†L116-L200„Äë„ÄêF:server.js‚Ä†L566-L799„Äë</p>
        <h4>Stock Take flow</h4>
        <ol>
          <li>Choose mode (stock take vs received).</li>
          <li>Search SKU and set/add quantities; entries persist locally in <span class="docsCode">localStorage</span>.</li>
        </ol>
        <p>This tool is local-only and does not talk to the backend or Shopify.„ÄêF:public/stock.js‚Ä†L34-L200„Äë</p>

        <hr class="docsDivider" />

        <h3>Running locally</h3>
        <pre class="docsBlock"><code>npm install
npm run dev</code></pre>
        <p>Open <span class="docsCode">http://localhost:3000</span> for Scan Station/Dispatch/Docs, <span class="docsCode">http://localhost:3000/flocs</span> for order capture, and <span class="docsCode">http://localhost:3000/stock.html</span> for stock take. The server listens on <span class="docsCode">HOST</span>/<span class="docsCode">PORT</span> and logs allowed origins on boot.„ÄêF:package.json‚Ä†L1-L16„Äë„ÄêF:server.js‚Ä†L1-L17„Äë</p>

        <hr class="docsDivider" />

        <h3>Developer guide</h3>
        <h4>Backend structure (refactored)</h4>
        <p>The backend is now organized into focused modules under <span class="docsCode">src/</span>:</p>
        <ul>
          <li><strong><span class="docsCode">src/app.js</span></strong> ‚Äî Express app setup (middleware, routes, static hosting).</li>
          <li><strong><span class="docsCode">src/config.js</span></strong> ‚Äî Environment configuration and defaults.</li>
          <li><strong><span class="docsCode">src/routes/</span></strong> ‚Äî Domain routers for Shopify, ParcelPerfect, PrintNode, alerts, and status.</li>
          <li><strong><span class="docsCode">src/services/</span></strong> ‚Äî External integrations (Shopify token/cache, SMTP).</li>
          <li><strong><span class="docsCode">src/utils/</span></strong> ‚Äî Shared HTTP helpers.</li>
        </ul>
        <p>The root <span class="docsCode">server.js</span> is a thin entrypoint that imports the app and starts the listener.„ÄêF:src/app.js‚Ä†L1-L65„Äë„ÄêF:src/config.js‚Ä†L1-L36„Äë„ÄêF:src/routes/shopify.js‚Ä†L1-L649„Äë„ÄêF:src/routes/parcelperfect.js‚Ä†L1-L104„Äë„ÄêF:src/routes/printnode.js‚Ä†L1-L62„Äë„ÄêF:src/routes/alerts.js‚Ä†L1-L60„Äë„ÄêF:src/routes/status.js‚Ä†L1-L48„Äë„ÄêF:src/services/shopify.js‚Ä†L1-L115„Äë„ÄêF:src/services/email.js‚Ä†L1-L21„Äë„ÄêF:src/utils/http.js‚Ä†L1-L6„Äë„ÄêF:server.js‚Ä†L1-L17„Äë</p>
        <h4>Adding a new backend endpoint</h4>
        <ol>
          <li>Create a new route file in <span class="docsCode">src/routes/</span> (or extend an existing router).</li>
          <li>Add shared integration logic in <span class="docsCode">src/services/</span> if needed.</li>
          <li>Register the router in <span class="docsCode">src/app.js</span>.</li>
          <li>Update the API reference in this README if the endpoint is public-facing.</li>
        </ol>
        <h4>Configuration tips</h4>
        <ul>
          <li>Keep new env vars grouped in <span class="docsCode">src/config.js</span> so defaults are centralized.</li>
          <li>For any email-related feature, reuse <span class="docsCode">src/services/email.js</span> so SMTP settings stay consistent.„ÄêF:src/config.js‚Ä†L1-L36„Äë„ÄêF:src/services/email.js‚Ä†L1-L21„Äë</li>
        </ul>

        <hr class="docsDivider" />

        <h3>Operational notes</h3>
        <ul>
          <li>The frontend assumes barcode format where the last three digits are parcel sequence numbers (<span class="docsCode">ORDERNO###</span>).„ÄêF:public/app.js‚Ä†L1160-L1197„Äë</li>
          <li>Orders are blocked locally after booking to reduce accidental duplicates; clear browser storage if you need a manual override on the same device.„ÄêF:public/app.js‚Ä†L430-L556„Äë„ÄêF:public/app.js‚Ä†L1170-L1208„Äë</li>
          <li>The Scan Station has a print-specific stylesheet for 100√ó150mm labels, and a local HTML fallback if ParcelPerfect PDF printing is unavailable.„ÄêF:public/index.html‚Ä†L200-L330„Äë„ÄêF:public/app.js‚Ä†L1460-L1716„Äë</li>
        </ul>

        <hr class="docsDivider" />

        <h3>File map</h3>
        <ul>
          <li><span class="docsCode">server.js</span> ‚Äî Entrypoint that starts the Express app. „ÄêF:server.js‚Ä†L1-L17„Äë</li>
          <li><span class="docsCode">src/app.js</span> ‚Äî Express middleware + route registration + static hosting. „ÄêF:src/app.js‚Ä†L1-L65„Äë</li>
          <li><span class="docsCode">src/config.js</span> ‚Äî Environment configuration defaults. „ÄêF:src/config.js‚Ä†L1-L36„Äë</li>
          <li><span class="docsCode">src/routes/</span> ‚Äî Domain routers for ParcelPerfect/Shopify/PrintNode/status/alerts. „ÄêF:src/routes/parcelperfect.js‚Ä†L1-L104„Äë„ÄêF:src/routes/shopify.js‚Ä†L1-L649„Äë„ÄêF:src/routes/printnode.js‚Ä†L1-L62„Äë„ÄêF:src/routes/status.js‚Ä†L1-L48„Äë„ÄêF:src/routes/alerts.js‚Ä†L1-L60„Äë</li>
          <li><span class="docsCode">src/services/</span> ‚Äî Shopify token cache + SMTP transport helpers. „ÄêF:src/services/shopify.js‚Ä†L1-L115„Äë„ÄêF:src/services/email.js‚Ä†L1-L21„Äë</li>
          <li><span class="docsCode">src/utils/http.js</span> ‚Äî Shared HTTP helpers (bad request, status). „ÄêF:src/utils/http.js‚Ä†L1-L6„Äë</li>
          <li><span class="docsCode">public/index.html</span> + <span class="docsCode">public/app.js</span> ‚Äî Scan Station + Dispatch Board + embedded docs. „ÄêF:public/index.html‚Ä†L1-L530„Äë„ÄêF:public/app.js‚Ä†L1-L1716„Äë</li>
          <li><span class="docsCode">public/flocs.html</span> + <span class="docsCode">public/flocs.js</span> ‚Äî FLOCS order capture tool. „ÄêF:public/flocs.html‚Ä†L1-L200„Äë„ÄêF:public/flocs.js‚Ä†L1-L200„Äë</li>
          <li><span class="docsCode">public/price-manager.html</span> + <span class="docsCode">public/price-manager.js</span> ‚Äî Price manager for tier pricing and storefront sync. „ÄêF:public/price-manager.html‚Ä†L1-L200„Äë„ÄêF:public/price-manager.js‚Ä†L1-L201„Äë</li>
          <li><span class="docsCode">public/stock.html</span> + <span class="docsCode">public/stock.js</span> ‚Äî Stock take tool. „ÄêF:public/stock.js‚Ä†L1-L200„Äë</li>
          <li><span class="docsCode">.env.example</span> ‚Äî Example environment config. „ÄêF:.env.example‚Ä†L1-L18„Äë</li>
          <li><span class="docsCode">package.json</span> ‚Äî Scripts and dependencies. „ÄêF:package.json‚Ä†L1-L16„Äë</li>
        </ul>
      </div>
    </div>
    <div class="flView" id="viewFlocs" hidden>
      <div class="flocs-shell" id="flocs-shell">
          <header class="flocs-header">
            <div class="flocs-titleBlock">
              <div class="flocs-title">Order Capture</div>
            </div>
            <div class="flocs-headerActions">
              <a class="flocs-linkBtn" href="/scan" data-route="/scan">
                <span>‚üµ</span>
                <span>Scan station</span>
              </a>
              <a class="flocs-linkBtn" href="/stock" data-route="/stock">
                <span>üì¶</span>
                <span>Stock take</span>
              </a>
            </div>
          </header>

          <main class="flocs-layout">
            <section class="flocs-panel form" id="flocs-formPanel">
              <div class="flocs-topGrid">
                <div class="flocs-topFields">
                  <!-- Customer -->
                  <div class="flocs-formSection">
                <div class="flocs-labelRow">
                  <span>Customer</span>
                  <span class="flocs-hint" id="flocs-customerStatus">Search by name, email, company, or phone</span>
                </div>
                <input id="flocs-customerSearch" class="flocs-input" type="text"
                       placeholder="Type to search Shopify customers‚Ä¶" autocomplete="off" />
                <div id="flocs-customerResults" class="flocs-customerResults" hidden></div>
                <div id="flocs-selectedCustomerChips" class="flocs-chipRow"></div>
                <div class="flocs-inlineActions" style="margin-top:.5rem">
                  <button id="flocs-customerCreateToggle" class="flocs-miniBtn" type="button">
                    Add new customer
                  </button>
                </div>
                <div class="flocs-subSection" id="flocs-customerCreatePanel" hidden>
                  <div class="flocs-labelRow">
                    <span>Create new customer</span>
                    <span class="flocs-hint" id="flocs-customerCreateStatus">Add a customer if search returns nothing.</span>
                  </div>
                  <div class="flocs-row">
                    <input id="flocs-customerFirst" class="flocs-input" type="text" placeholder="First name" />
                    <input id="flocs-customerLast" class="flocs-input" type="text" placeholder="Last name" />
                  </div>
                  <div class="flocs-row" style="margin-top:.4rem">
                    <input id="flocs-customerEmail" class="flocs-input" type="email" placeholder="Email" />
                    <input id="flocs-customerPhone" class="flocs-input" type="tel" placeholder="Phone" />
                  </div>
                  <div class="flocs-row" style="margin-top:.4rem">
                    <input id="flocs-customerCompany" class="flocs-input" type="text" placeholder="Company (optional)" />
                    <select id="flocs-customerDelivery" class="flocs-select">
                      <option value="">Default delivery (optional)</option>
                      <option value="ship">Ship</option>
                      <option value="pickup">Pickup</option>
                      <option value="deliver">Deliver</option>
                    </select>
                  </div>
                  <div class="flocs-row" style="margin-top:.4rem">
                    <input id="flocs-customerVat" class="flocs-input" type="text" placeholder="VAT number (optional)" />
                  </div>
                  <div class="flocs-row" style="margin-top:.4rem">
                    <textarea id="flocs-customerDeliveryNotes" class="flocs-input" rows="2" placeholder="Delivery instructions (optional)"></textarea>
                  </div>
                  <div class="flocs-row" style="margin-top:.4rem">
                    <input id="flocs-customerAddr1" class="flocs-input" type="text" placeholder="Address line 1" />
                    <input id="flocs-customerAddr2" class="flocs-input" type="text" placeholder="Address line 2" />
                  </div>
                  <div class="flocs-row" style="margin-top:.4rem">
                    <input id="flocs-customerCity" class="flocs-input" type="text" placeholder="City" />
                    <input id="flocs-customerProvince" class="flocs-input" type="text" placeholder="Province" />
                  </div>
                  <div class="flocs-row" style="margin-top:.4rem">
                    <input id="flocs-customerZip" class="flocs-input" type="text" placeholder="Postal code" />
                    <input id="flocs-customerCountry" class="flocs-input" type="text" placeholder="Country" value="South Africa" />
                  </div>
                  <div class="flocs-inlineActions" style="margin-top:.5rem">
                    <button id="flocs-customerCreateBtn" class="flocs-btn primary" type="button">
                      <span class="icon">‚ûï</span><span>Create customer</span>
                    </button>
                    <button id="flocs-customerResetBtn" class="flocs-miniBtn" type="button">Clear form</button>
                  </div>
                </div>
              </div>

                  <!-- PO + Delivery method -->
                  <div class="flocs-formSection">
                    <div class="flocs-row">
                      <div>
                        <div class="flocs-labelRow">
                          <span>Customer PO</span>
                          <span class="flocs-hint">Stored on draft order note & metafield</span>
                        </div>
                        <input id="flocs-po" class="flocs-input" type="text" placeholder="PO / reference (optional)" />
                      </div>
                      <div>
                        <div class="flocs-labelRow">
                          <span>Delivery type</span>
                          <span class="flocs-hint">Uses customer metafield custom.delivery_method if set</span>
                        </div>
                        <div class="flocs-radioGroup" id="flocs-deliveryGroup">
                          <label class="flocs-radioPill">
                            <input type="radio" name="delivery" value="ship" checked />
                            <span>Ship</span>
                          </label>
                          <label class="flocs-radioPill">
                            <input type="radio" name="delivery" value="pickup" />
                            <span>Pickup</span>
                          </label>
                          <label class="flocs-radioPill">
                            <input type="radio" name="delivery" value="deliver" />
                            <span>Deliver (own vehicle)</span>
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Billing address selector -->
                  <div class="flocs-formSection" id="flocs-billSection">
                    <div class="flocs-labelRow">
                      <span>Billing address</span>
                      <span class="flocs-hint">Pulled from customer‚Äôs Shopify addresses</span>
                    </div>
                    <select id="flocs-billingAddressSelect" class="flocs-select">
                      <option value="">Select a customer first‚Ä¶</option>
                    </select>
                    <div id="flocs-billingAddressPreview" class="flocs-addressPreview" hidden></div>
                  </div>

                  <!-- Shipping address selector -->
                  <div class="flocs-formSection" id="flocs-shipSection">
                    <div class="flocs-labelRow">
                      <span>Shipping address</span>
                      <span class="flocs-hint">Saved to the draft order even for pickup/deliver</span>
                    </div>
                    <select id="flocs-addressSelect" class="flocs-select">
                      <option value="">Select a customer first‚Ä¶</option>
                    </select>
                    <div id="flocs-addressPreview" class="flocs-addressPreview" hidden></div>
                  </div>
                </div>

                <aside class="flocs-panel flocs-previewPanel" aria-label="Invoice preview">
                  <div class="flocs-previewHeader">
                    <div>
                      <div class="flocs-previewTitle">Invoice preview</div>
                    </div>
                    <div>
                      <div id="flocs-previewTag" class="flocs-previewTag">Waiting for customer‚Ä¶</div>
                      <button id="flocs-armBtn" class="flocs-armBtn" type="button" hidden>Arm lock</button>
                      <button id="flocs-convertBtn" class="flocs-convertBtn" type="button" hidden>
                        Convert draft to order
                      </button>
                      <button id="flocs-createOrderBtn" class="flocs-createOrderBtn" type="button" hidden>
                        Create order now
                      </button>
                    </div>
                  </div>

                  <div class="flocs-invoice" id="flocs-invoice">
                    <!-- Filled by JS -->
                  </div>
                </aside>
              </div>

              <!-- Product grid -->
              <div class="flocs-formSection">
              <div class="flocs-labelRow">
                <span>Items</span>
                <span class="flocs-hint" id="flocs-productStatus">Search by SKU or product title</span>
              </div>
                <div class="flocs-row" style="margin-bottom:.5rem">
                  <select id="flocs-collectionSelect" class="flocs-select">
                    <option value="">Load a collection‚Ä¶</option>
                    <option value="most-popular-products">Most popular products (public)</option>
                  </select>
                  <button id="flocs-collectionLoadBtn" class="flocs-btn" type="button">
                    <span class="icon">‚≠ê</span><span>Load collection</span>
                  </button>
                </div>
                <div class="flocs-row" style="margin-bottom:.5rem">
                  <input id="flocs-productSearch" class="flocs-input" type="text"
                         placeholder="Search Shopify products (SKU/title)..." autocomplete="off" />
                  <input id="flocs-productCode" class="flocs-input" type="text"
                         placeholder="Filter by product code (exact SKU)..." autocomplete="off" />
                </div>
                <div id="flocs-productResults" class="flocs-productResults" hidden></div>
                <div class="flocs-actionsRow" id="flocs-productPager" hidden>
                  <button id="flocs-productPrev" class="flocs-btn" type="button">
                    <span class="icon">‚¨Ö</span><span>Previous</span>
                  </button>
                  <button id="flocs-productNext" class="flocs-btn" type="button">
                    <span class="icon">‚û°</span><span>Next</span>
                  </button>
                </div>
                <div class="flocs-filterRow">
                  <select id="flocs-filterFlavour" class="flocs-select">
                    <option value="">All flavours</option>
                  </select>
                  <select id="flocs-filterSize" class="flocs-select">
                    <option value="">All sizes</option>
                  </select>
                  <span class="flocs-filterHint">Filter the quick order list by flavour & size.</span>
                </div>
                <table class="flocs-productsTable">
                  <thead>
                    <tr>
                      <th>SKU</th>
                      <th>Description</th>
                      <th>Flavour</th>
                      <th>Size</th>
                      <th>Price</th>
                      <th>Override</th>
                      <th style="width:10%">Qty</th>
                    </tr>
                  </thead>
                  <tbody id="flocs-productsBody">
                    <!-- Populated by JS -->
                  </tbody>
                </table>
                <div class="flocs-actionsRow">
                  <button id="flocs-calcShip" class="flocs-btn" type="button">
                    <span class="icon">‚õü</span><span>Calculate shipping (SWE quote)</span>
                  </button>
                  <div id="flocs-shippingSummary" class="flocs-badgeShipping">No shipping quote yet.</div>
                </div>
                <div id="flocs-errors" class="flocs-errors"></div>
              </div>
            </section>

          </main>
        </div>

        <!-- Global toast -->
        <div id="flocs-toast" class="flocs-toast"></div>

        <!-- Ready/confirm overlay -->
        <div id="flocs-confirmOverlay" class="flocs-confirmOverlay">
          <div class="flocs-confirmActions">
            <button id="flocs-confirmBtn" class="flocs-confirmBtn" type="button">
              <span class="icon">‚úÖ</span>
              <span>Lock order & create Shopify draft</span>
            </button>
            <button id="flocs-disarmBtn" class="flocs-disarmBtn" type="button">Disarm</button>
          </div>
        </div>
    </div>

    <div class="flView" id="viewStock" hidden>
      <div class="stock-shell">
        <section class="stock-card">
          <h2>Stock overview</h2>
          <div class="stock-toolbar">
            <input id="stock-search" class="stock-input" type="text" placeholder="Search SKU or product name..." />
          </div>
          <table class="stock-table">
            <thead>
              <tr>
                <th>SKU</th>
                <th>Product</th>
                <th>Current</th>
                <th>Count 1</th>
                <th>Count 2</th>
                <th>Count 3</th>
                <th>Total</th>
                <th>Crates</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="stock-tableBody"></tbody>
          </table>
        </section>
        </div>
    </div>

    <div class="flView" id="viewPriceManager" hidden>
      <div class="pm-shell">
          <header class="pm-header">
            <div class="pm-titleBlock">
              <div class="pm-title">Price Manager</div>
              <div class="pm-sub">Manage tier pricing per SKU and sync to Shopify metafields + storefront.</div>
            </div>
          </header>

          <section class="pm-panel">
            <div class="pm-row">
              <span id="pmStatus" class="pm-muted">Loading product list‚Ä¶</span>
            </div>

            <div style="overflow:auto;">
              <table class="pm-productsTable">
                <thead>
                  <tr>
                    <th>SKU</th>
                    <th>Title</th>
                    <th>Public</th>
                    <th>Agent</th>
                    <th>Retailer</th>
                    <th>Export</th>
                    <th>Private</th>
                    <th>FKB</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="pmTableBody">
                  <tr>
                    <td colspan="9" class="pm-muted">Loading products‚Ä¶</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>
        </div>
        <div id="pmToast" class="pm-toast"></div>
    </div>

      </main>
    </div>
  </div>

  <div class="slotEgg" id="slotEgg" hidden aria-hidden="true">
    <div class="slotEgg__backdrop" data-slot-close></div>
    <div class="slotEgg__panel" role="dialog" aria-modal="true" aria-labelledby="slotEggTitle">
      <div class="slotEgg__header">
        <h2 class="slotEgg__title" id="slotEggTitle">Secret Spice Slots</h2>
        <button class="slotEgg__close" type="button" data-slot-close aria-label="Close spice slots">‚úï</button>
      </div>
      <p class="slotEgg__hint">Pull the lever and see which blend lines up.</p>
      <div class="slotEgg__reels">
        <div class="slotEgg__reel" data-slot-reel>üå∂Ô∏è Chilli</div>
        <div class="slotEgg__reel" data-slot-reel>üßÑ Garlic</div>
        <div class="slotEgg__reel" data-slot-reel>üßÇ Sea Salt</div>
      </div>
      <div class="slotEgg__actions">
        <button class="slotEgg__spin" id="slotSpinBtn" type="button">Spin</button>
        <div class="slotEgg__result" id="slotResult">Match all three for a ‚Äúhouse blend‚Äù win.</div>
      </div>
    </div>
  </div>

<!-- PRINT-ONLY MOUNT -->
<div class="printSheetWrapper"><div id="printMount"></div></div>

<script type="module" src="/app.js"></script>
</body> 
</html>
